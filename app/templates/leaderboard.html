<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Leaderboard · Urban Climb Comp</title>
	<link rel="stylesheet" href="/static/app.css" />
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background: linear-gradient(135deg, #0a1628 0%, #1a2942 100%);
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			color: #fff;
		}

		.nav {
			padding: 1.25rem 2rem;
			display: flex;
			gap: 1.5rem;
			align-items: center;
			flex-wrap: wrap;
		}

		.nav a {
			color: rgba(255, 255, 255, 0.7);
			text-decoration: none;
			font-size: 0.95rem;
			transition: color 0.2s;
			font-weight: 600;
		}

		.nav a.active { color: #5df4a2; font-weight: 800; }
		.nav a:hover { color: #fff; }

		.container {
			flex: 1;
			max-width: 1200px;
			margin: 0 auto;
			padding: 2rem;
			width: 100%;
		}

		.page-header { margin-bottom: 2rem; }

		.page-title {
			font-size: 2.5rem;
			font-weight: 900;
			margin-bottom: 0.75rem;
			background: linear-gradient(135deg, #fff 0%, #5df4a2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			letter-spacing: -0.02em;
		}

		.page-subtitle {
			font-size: 1.1rem;
			color: rgba(255, 255, 255, 0.75);
			margin-bottom: 1.5rem;
		}

		.page-subtitle span { color: #5df4a2; font-weight: 800; }

		.category-tabs {
			display: flex;
			gap: 0.75rem;
			flex-wrap: wrap;
		}

		.category-tab {
			padding: 0.75rem 1.5rem;
			border-radius: 999px;
			border: 2px solid rgba(255, 255, 255, 0.2);
			background: rgba(255, 255, 255, 0.05);
			color: rgba(255, 255, 255, 0.85);
			font-size: 0.95rem;
			font-weight: 800;
			transition: all 0.2s;
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			cursor: pointer;
			user-select: none;
			-webkit-tap-highlight-color: transparent;
		}

		.category-tab:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: rgba(255, 255, 255, 0.4);
			transform: translateY(-1px);
		}

		.category-tab.active {
			background: #5df4a2;
			color: #0a1628;
			border-color: #5df4a2;
			transform: translateY(-1px);
			box-shadow: 0 10px 20px rgba(93, 244, 162, 0.3);
		}

		.category-tab:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none;
		}

		.loading-dot {
			display: inline-block;
			width: 8px;
			height: 8px;
			border-radius: 999px;
			background: currentColor;
			opacity: 0.85;
			animation: pulse 1s infinite ease-in-out;
		}
		@keyframes pulse {
			0%, 100% { transform: scale(0.85); opacity: 0.5; }
			50% { transform: scale(1.05); opacity: 1; }
		}

		.leaderboard-wrapper {
			background: rgba(255, 255, 255, 0.05);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 1.5rem;
			overflow: hidden;
			transition: opacity .15s ease;
		}
		.leaderboard-wrapper.loading { opacity: 0.86; }

		.leaderboard {
			width: 100%;
			border-collapse: collapse;
		}

		.leaderboard thead th {
			text-align: left;
			font-weight: 800;
			padding: 1.25rem 1.5rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			color: rgba(255, 255, 255, 0.7);
			font-size: 0.9rem;
			letter-spacing: 0.05em;
			text-transform: uppercase;
			background: rgba(255, 255, 255, 0.02);
		}

		.leaderboard tbody td {
			padding: 1.25rem 1.5rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			color: #fff;
			font-size: 1rem;
		}

		.leaderboard tbody tr { transition: background 0.15s; }
		.leaderboard tbody tr:hover { background: rgba(255, 255, 255, 0.05); }

		#leaderboard-body tr:nth-child(1) { background: rgba(255, 215, 0, 0.08); border-left: 4px solid #FFD700; }
		#leaderboard-body tr:nth-child(2) { background: rgba(192, 192, 192, 0.08); border-left: 4px solid #C0C0C0; }
		#leaderboard-body tr:nth-child(3) { background: rgba(205, 127, 50, 0.08); border-left: 4px solid #CD7F32; }

		.leaderboard tbody td:first-child { font-weight: 950; font-size: 1.1rem; }

		.leaderboard.singles th:nth-child(3),
		.leaderboard.singles td:nth-child(3),
		.leaderboard.singles th:nth-child(4),
		.leaderboard.singles td:nth-child(4),
		.leaderboard.singles th:nth-child(5),
		.leaderboard.singles td:nth-child(5) { text-align: center; }

		.leaderboard.doubles th:nth-child(3),
		.leaderboard.doubles td:nth-child(3) { text-align: center; }

		.leaderboard a {
			color: #5df4a2;
			text-decoration: none;
			font-weight: 700;
			transition: color 0.2s;
		}
		.leaderboard a:hover { color: #7fffa4; text-decoration: underline; }

		@media (max-width: 768px) {
			.nav { padding: 1rem; }
			.container { padding: 1.5rem 1rem; }
			.page-title { font-size: 2rem; }
			.page-subtitle { font-size: 1rem; }

			.leaderboard thead th,
			.leaderboard tbody td {
				padding: 1rem 0.75rem;
				font-size: 0.9rem;
			}

			.leaderboard.singles thead th:nth-child(4),
			.leaderboard.singles tbody td:nth-child(4) { display: none; }
		}
	</style>
</head>

<body>
	{% set is_logged_in = session.get('account_id') %}
	{% set viewer_id = session.get('competitor_id') %}
	{% set is_admin = session.get('admin_ok', False) %}
	{% set comp_slug = comp_slug if comp_slug is defined else session.get('active_comp_slug') %}

	{% set cid_q = (request.args.get('cid') or '').strip() %}
	{% set cid_val = (cid_q if cid_q else (viewer_id if viewer_id else '')) %}

	{% set qs = [] %}
	{% if cid_val %}{% set _ = qs.append('cid=' ~ cid_val) %}{% endif %}
	{% set qs_str = ('?' ~ (qs|join('&'))) if qs|length else '' %}

	{% set show_comp_nav = (comp_slug and cid_val) %}

	<nav class="nav">
		<a href="{% if is_logged_in or is_admin %}/my-comps{% else %}/{% endif %}"
		   class="{% if nav_active == 'my_comps' %}active{% endif %}">Home</a>

		{% if is_admin %}
			<a href="/admin/comps" class="{% if nav_active == 'admin' %}active{% endif %}">Admin</a>
		{% endif %}

		{% if show_comp_nav %}
			<a href="/comp/{{ comp_slug }}/competitor/{{ cid_val }}/sections"
			   class="{% if nav_active == 'sections' %}active{% endif %}">Scoring</a>

			<a href="/competitor/{{ cid_val }}/stats/my"
			   class="{% if nav_active == 'my_stats' %}active{% endif %}">My Stats</a>

			<a href="/competitor/{{ cid_val }}/stats/overall"
			   class="{% if nav_active == 'overall_stats' %}active{% endif %}">Overall Stats</a>
		{% endif %}

		<a href="/leaderboard{{ qs_str }}"
		   class="{% if nav_active == 'leaderboard' %}active{% endif %}">Leaderboard</a>

		{% if comp_slug %}
			<a class="{% if nav_active == 'doubles' %}active{% endif %}"
			   href="/comp/{{ comp_slug }}/doubles">Doubles</a>
		{% endif %}

		{% if is_logged_in or is_admin %}
			<a href="/logout">Log out</a>
		{% else %}
			<a href="/login{% if comp_slug %}?slug={{ comp_slug }}{% endif %}"
			   class="{% if nav_active == 'login' %}active{% endif %}">Log in</a>
		{% endif %}
	</nav>

	<main class="container">
		<header class="page-header">
			<h1 class="page-title">Leaderboard</h1>
			<p class="page-subtitle">
				Category: <span id="category-label">All</span>
			</p>

			<div class="category-tabs" id="category-tabs">
				<button type="button" class="category-tab" data-cat="all">All</button>
				<button type="button" class="category-tab" data-cat="male">Male</button>
				<button type="button" class="category-tab" data-cat="female">Female</button>
				<button type="button" class="category-tab" data-cat="inclusive">Inclusive</button>
				<button type="button" class="category-tab" data-cat="doubles">Doubles</button>
			</div>
		</header>

		<div class="leaderboard-wrapper" id="lb-wrap">
			<table class="leaderboard singles" id="leaderboard-table">
				<thead id="leaderboard-head">
					<tr><th>Pos</th><th>Competitor</th><th>Tops</th><th>Attempts</th><th>Points</th></tr>
				</thead>
				<tbody id="leaderboard-body">
					<tr><td colspan="5" style="opacity:.75;">Loading…</td></tr>
				</tbody>
			</table>
		</div>
	</main>

	<script>
		(() => {
			const CATEGORIES = [
				{ key: "all",       label: "All",              isDoubles: false },
				{ key: "male",      label: "Male",             isDoubles: false },
				{ key: "female",    label: "Female",           isDoubles: false },
				{ key: "inclusive", label: "Gender Inclusive", isDoubles: false },
				{ key: "doubles",   label: "Doubles",          isDoubles: true  },
			];

			const allowed   = new Set(CATEGORIES.map(c => c.key));
			const catByKey  = new Map(CATEGORIES.map(c => [c.key, c]));

			const tabsEl  = document.getElementById("category-tabs");
			const labelEl = document.getElementById("category-label");
			const wrapEl  = document.getElementById("lb-wrap");
			const tableEl = document.getElementById("leaderboard-table");
			const headEl  = document.getElementById("leaderboard-head");
			const bodyEl  = document.getElementById("leaderboard-body");

			const CID = "{{ cid_val }}";

			// Monotonic counter — every new load() call increments this.
			// A fetch result is only applied if its token still equals latestToken
			// when it resolves, guaranteeing only the most-recently-requested
			// category ever reaches the DOM.
			let latestToken = 0;
			let aborter     = null;

			// Track which key the UI is currently showing (drives tab highlight & header)
			let currentKey  = "all";

			function escapeHtml(val) {
				return String(val ?? "")
					.replaceAll("&", "&amp;")
					.replaceAll("<", "&lt;")
					.replaceAll(">", "&gt;")
					.replaceAll('"', "&quot;")
					.replaceAll("'", "&#039;");
			}

			// ── Tab & header state ──────────────────────────────────────────────
			// Only called with the key that should be "current" right now.
			// Never touches innerHTML of non-active tabs so labels never get clobbered.
			function applyTabState(key, isLoading) {
				const cat = catByKey.get(key) || catByKey.get("all");
				labelEl.textContent = cat.label;

				[...tabsEl.querySelectorAll(".category-tab")].forEach(btn => {
					const isActive = btn.dataset.cat === key;
					btn.classList.toggle("active", isActive);
					btn.disabled = isLoading;

					// Only rewrite the innerHTML of the active tab (to add/remove spinner)
					if (isActive) {
						const baseText = cat.label; // use the full label string, not dataset.cat
						btn.innerHTML = isLoading
							? `${escapeHtml(baseText)} <span class="loading-dot"></span>`
							: escapeHtml(baseText);
					}
				});

				// Swap table header & class between singles / doubles
				if (cat.isDoubles) {
					tableEl.classList.remove("singles");
					tableEl.classList.add("doubles");
					headEl.innerHTML = `<tr><th>Pos</th><th>Team</th><th>Points</th></tr>`;
				} else {
					tableEl.classList.remove("doubles");
					tableEl.classList.add("singles");
					headEl.innerHTML = `<tr><th>Pos</th><th>Competitor</th><th>Tops</th><th>Attempts</th><th>Points</th></tr>`;
				}
			}

			function renderLoading(key) {
				const cat = catByKey.get(key) || catByKey.get("all");
				bodyEl.innerHTML = `<tr><td colspan="${cat.isDoubles ? 3 : 5}" style="opacity:.75;">Loading…</td></tr>`;
			}

			function renderRows(key, rows) {
				const cat = catByKey.get(key) || catByKey.get("all");

				if (!rows || !rows.length) {
					bodyEl.innerHTML = `<tr><td colspan="${cat.isDoubles ? 3 : 5}" style="opacity:.75;">${
						cat.isDoubles ? "No doubles teams yet." : "No competitors yet."
					}</td></tr>`;
					return;
				}

				if (cat.isDoubles) {
					bodyEl.innerHTML = rows.map(r => `
						<tr>
							<td>${escapeHtml(r.position)}</td>
							<td>${escapeHtml(r.name)}</td>
							<td>${escapeHtml(r.total_points)}</td>
						</tr>
					`).join("");
				} else {
					bodyEl.innerHTML = rows.map(r => {
						const link = r.competitor_id
							? `<a href="/competitor/${encodeURIComponent(r.competitor_id)}/stats/climber">${escapeHtml(r.name)}</a>`
							: escapeHtml(r.name);
						return `
							<tr>
								<td>${escapeHtml(r.position)}</td>
								<td>${link}</td>
								<td>${escapeHtml(r.tops)}</td>
								<td>${escapeHtml(r.attempts_on_tops)}</td>
								<td>${escapeHtml(r.total_points)}</td>
							</tr>
						`;
					}).join("");
				}
			}

			function renderError(key, msg) {
				const cat = catByKey.get(key) || catByKey.get("all");
				bodyEl.innerHTML = `<tr><td colspan="${cat.isDoubles ? 3 : 5}" style="opacity:.75;">${escapeHtml(msg)}</td></tr>`;
			}

			function urlFor(key) {
				const path = (key && key !== "all") ? `/leaderboard/${encodeURIComponent(key)}` : "/leaderboard";
				const params = new URLSearchParams();
				if (CID) params.set("cid", CID);
				const qs = params.toString();
				return qs ? `${path}?${qs}` : path;
			}

			function initialKeyFromPath() {
				const parts = (location.pathname || "").split("/").filter(Boolean);
				// Path is either /leaderboard or /leaderboard/<key>
				const maybe = parts.length >= 2 ? parts[1] : "all";
				return allowed.has(maybe) ? maybe : "all";
			}

			async function load(key, { push = true } = {}) {
				const k = allowed.has(key) ? key : "all";

				// Claim this load slot
				const token = ++latestToken;

				// Cancel any in-flight request
				if (aborter) { aborter.abort(); aborter = null; }
				aborter = new AbortController();

				// Update UI to show loading state for the requested category
				currentKey = k;
				applyTabState(k, true);
				renderLoading(k);
				wrapEl.classList.add("loading");

				if (push) history.pushState({ key: k }, "", urlFor(k));

				const params = new URLSearchParams({ category: k });
				if (CID) params.set("cid", CID);

				try {
					const resp = await fetch(`/api/leaderboard?${params}`, {
						method: "GET",
						cache: "no-store",
						signal: aborter.signal,
						headers: { "Accept": "application/json" },
					});

					// If a newer load() has started, discard this response entirely
					if (token !== latestToken) return;

					if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
					const data = await resp.json();

					if (token !== latestToken) return;

					// ── Category mismatch guard ───────────────────────────────────
					// The server echoes back cat_key so we can detect if the response
					// belongs to a different category (e.g. a very late reply arriving
					// after the token check but before we close the aborter).
					// This replaces the unreliable shape-detection heuristic.
					if (data.cat_key && data.cat_key !== k) {
						// Stale or mismatched response — silently discard
						return;
					}

					renderRows(k, data.rows || []);

				} catch (err) {
					if (err.name === "AbortError") return;
					if (token !== latestToken) return;
					renderError(k, "Error loading leaderboard. Try again.");
				} finally {
					// Only update loading visuals if we are still the active request
					if (token === latestToken) {
						applyTabState(k, false);
						wrapEl.classList.remove("loading");
					}
				}
			}

			// ── Event wiring ────────────────────────────────────────────────────
			tabsEl.addEventListener("click", e => {
				const btn = e.target.closest(".category-tab");
				if (!btn || btn.disabled) return;
				load(btn.dataset.cat, { push: true });
			});

			window.addEventListener("popstate", e => {
				const key = (e.state && e.state.key) ? e.state.key : initialKeyFromPath();
				load(key, { push: false });
			});

			// Initial load — no history push since we're already on this URL
			load(initialKeyFromPath(), { push: false });
		})();
	</script>
</body>
</html>