<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Leaderboard · Urban Climb Comp</title>
	<link rel="stylesheet" href="/static/app.css" />
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background: linear-gradient(135deg, #0a1628 0%, #1a2942 100%);
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			color: #fff;
		}

		.nav {
			padding: 1.25rem 2rem;
			display: flex;
			gap: 1.5rem;
			align-items: center;
			flex-wrap: wrap;
		}

		.nav a {
			color: rgba(255, 255, 255, 0.7);
			text-decoration: none;
			font-size: 0.95rem;
			transition: color 0.2s;
			font-weight: 600;
		}

		.nav a.active { color: #5df4a2; font-weight: 800; }
		.nav a:hover { color: #fff; }

		.container {
			flex: 1;
			max-width: 1200px;
			margin: 0 auto;
			padding: 2rem;
			width: 100%;
		}

		.page-header { margin-bottom: 2rem; }

		.page-title {
			font-size: 2.5rem;
			font-weight: 900;
			margin-bottom: 0.75rem;
			background: linear-gradient(135deg, #fff 0%, #5df4a2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			letter-spacing: -0.02em;
		}

		.page-subtitle {
			font-size: 1.1rem;
			color: rgba(255, 255, 255, 0.75);
			margin-bottom: 1.5rem;
		}

		.page-subtitle span { color: #5df4a2; font-weight: 800; }

		.category-tabs {
			display: flex;
			gap: 0.75rem;
			flex-wrap: wrap;
		}

		.category-tab {
			padding: 0.75rem 1.5rem;
			border-radius: 999px;
			border: 2px solid rgba(255, 255, 255, 0.2);
			background: rgba(255, 255, 255, 0.05);
			color: rgba(255, 255, 255, 0.85);
			font-size: 0.95rem;
			font-weight: 800;
			transition: all 0.2s;
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			cursor: pointer;
			user-select: none;
			-webkit-tap-highlight-color: transparent;
		}

		.category-tab:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: rgba(255, 255, 255, 0.4);
			transform: translateY(-1px);
		}

		.category-tab.active {
			background: #5df4a2;
			color: #0a1628;
			border-color: #5df4a2;
			transform: translateY(-1px);
			box-shadow: 0 10px 20px rgba(93, 244, 162, 0.3);
		}

		.category-tab:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none;
		}

		.loading-dot {
			display: inline-block;
			width: 8px;
			height: 8px;
			border-radius: 999px;
			background: currentColor;
			opacity: 0.85;
			animation: pulse 1s infinite ease-in-out;
		}
		@keyframes pulse {
			0%, 100% { transform: scale(0.85); opacity: 0.5; }
			50% { transform: scale(1.05); opacity: 1; }
		}

		.leaderboard-wrapper {
			background: rgba(255, 255, 255, 0.05);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 1.5rem;
			overflow: hidden;
			transition: opacity .15s ease;
		}
		.leaderboard-wrapper.loading { opacity: 0.86; }

		.leaderboard {
			width: 100%;
			border-collapse: collapse;
		}

		.leaderboard thead th {
			text-align: left;
			font-weight: 800;
			padding: 1.25rem 1.5rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			color: rgba(255, 255, 255, 0.7);
			font-size: 0.9rem;
			letter-spacing: 0.05em;
			text-transform: uppercase;
			background: rgba(255, 255, 255, 0.02);
		}

		.leaderboard tbody td {
			padding: 1.25rem 1.5rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			color: #fff;
			font-size: 1rem;
		}

		.leaderboard tbody tr { transition: background 0.15s; }
		.leaderboard tbody tr:hover { background: rgba(255, 255, 255, 0.05); }

		#leaderboard-body tr.lb-main:nth-of-type(1) { background: rgba(255, 215, 0, 0.08); border-left: 4px solid #FFD700; }
		#leaderboard-body tr.lb-main:nth-of-type(2) { background: rgba(192, 192, 192, 0.08); border-left: 4px solid #C0C0C0; }
		#leaderboard-body tr.lb-main:nth-of-type(3) { background: rgba(205, 127, 50, 0.08); border-left: 4px solid #CD7F32; }

		.leaderboard tbody td:first-child { font-weight: 950; font-size: 1.1rem; }

		.leaderboard.singles th:nth-child(3),
		.leaderboard.singles td:nth-child(3),
		.leaderboard.singles th:nth-child(4),
		.leaderboard.singles td:nth-child(4),
		.leaderboard.singles th:nth-child(5),
		.leaderboard.singles td:nth-child(5) { text-align: center; }

		.leaderboard.doubles th:nth-child(3),
		.leaderboard.doubles td:nth-child(3) { text-align: center; }

		.name-cell { padding: 0 !important; }

		.expander {
			width: 100%;
			background: transparent;
			border: 0;
			color: inherit;
			text-align: left;
			padding: 1.25rem 1.5rem;
			display: flex;
			align-items: center;
			gap: 0.75rem;
			cursor: pointer;
			font: inherit;
		}

		.expander:focus-visible {
			outline: 2px solid rgba(93, 244, 162, 0.85);
			outline-offset: 2px;
			border-radius: 0.75rem;
		}

		.chev {
			display: inline-block;
			transition: transform 160ms ease;
			opacity: 0.9;
			transform: translateY(-1px);
		}
		.expander.open .chev { transform: rotate(90deg) translateY(-1px); }

		.nm { font-weight: 950; font-size: 1.05rem; }

		.lb-details td {
			padding: 0 !important;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}
		.details-wrap {
			padding: 0.75rem 1.5rem 1.25rem 3.5rem;
			background: rgba(255, 255, 255, 0.02);
			border-top: 1px solid rgba(255, 255, 255, 0.06);
		}
		.details-loading {
			opacity: 0.75;
			font-weight: 700;
			padding: 0.4rem 0;
		}
		.details-table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 0.5rem;
		}
		.details-table th {
			text-align: left;
			font-weight: 800;
			color: rgba(255, 255, 255, 0.65);
			font-size: 0.85rem;
			letter-spacing: 0.05em;
			text-transform: uppercase;
			padding: 0.5rem 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.08);
		}
		.details-table td {
			padding: 0.6rem 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			font-size: 0.95rem;
			color: rgba(255, 255, 255, 0.92);
		}
		.details-table tr:last-child td { border-bottom: 0; }
		.details-table th:nth-child(2),
		.details-table td:nth-child(2),
		.details-table th:nth-child(3),
		.details-table td:nth-child(3) { text-align: right; }

		.pagination {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 0.75rem;
			margin-top: 1.25rem;
			flex-wrap: wrap;
		}

		.page-btn {
			border-radius: 999px;
			border: 2px solid rgba(255, 255, 255, 0.18);
			background: rgba(255, 255, 255, 0.06);
			color: rgba(255, 255, 255, 0.92);
			font-weight: 900;
			padding: 0.6rem 1rem;
			cursor: pointer;
			transition: transform 0.15s, background 0.15s, border-color 0.15s;
			user-select: none;
			-webkit-tap-highlight-color: transparent;
		}

		.page-btn:hover {
			transform: translateY(-1px);
			background: rgba(255, 255, 255, 0.10);
			border-color: rgba(255, 255, 255, 0.32);
		}

		.page-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
			transform: none;
		}

		.page-info {
			opacity: 0.85;
			font-weight: 800;
		}

		@media (max-width: 768px) {
			.nav { padding: 1rem; }
			.container { padding: 1.5rem 1rem; }
			.page-title { font-size: 2rem; }
			.page-subtitle { font-size: 1rem; }

			.leaderboard thead th,
			.leaderboard tbody td {
				padding: 1rem 0.75rem;
				font-size: 0.9rem;
			}

			.leaderboard.singles thead th:nth-child(4),
			.leaderboard.singles tbody tr.lb-main td:nth-child(4) { display: none; }

			.details-wrap { padding: 0.65rem 0.75rem 1rem 1.5rem; }
			.expander { padding: 1rem 0.75rem; }
		}
	</style>
</head>

<body>
	{% set is_logged_in = session.get('account_id') %}
	{% set viewer_id = session.get('competitor_id') %}
	{% set is_admin = session.get('admin_ok', False) %}
	{% set comp_slug = comp_slug if comp_slug is defined else session.get('active_comp_slug') %}

	{# ✅ ADMIN-ONLY MODE FLAG (prevents competitor nav leaking in) #}
	{% set admin_flag = (request.args.get('admin') or '').strip() %}
	{% set admin_only = (is_admin and admin_flag == '1') %}

	{# cid from query, but DO NOT fall back to competitor_id in admin_only mode #}
	{% set cid_q = (request.args.get('cid') or '').strip() %}
	{% if admin_only %}
		{% set cid_val = (cid_q if cid_q else '') %}
	{% else %}
		{% set cid_val = (cid_q if cid_q else (viewer_id if viewer_id else '')) %}
	{% endif %}

	{# querystring builder (preserve cid + admin) #}
	{% set qs = [] %}
	{% if cid_val %}{% set _ = qs.append('cid=' ~ cid_val) %}{% endif %}
	{% if admin_only %}{% set _ = qs.append('admin=1') %}{% endif %}
	{% set qs_str = ('?' ~ (qs|join('&'))) if qs|length else '' %}

	{# Only show competitor-scoped nav when we truly have a competitor for this view #}
	{% set show_comp_nav = (not admin_only) and (comp_slug and cid_val) %}

	<nav class="nav">
		{# HOME: in admin_only mode keep them in admin-land #}
		<a href="{% if admin_only %}/admin/comps{% elif is_logged_in or is_admin %}/my-comps{% else %}/{% endif %}"
		   class="{% if nav_active == 'my_comps' %}active{% endif %}">
			{% if admin_only %}Admin{% else %}Home{% endif %}
		</a>

		{# ✅ prevent duplicate Admin link in admin_only mode #}
		{% if is_admin and (not admin_only) %}
			<a href="/admin/comps" class="{% if nav_active == 'admin' %}active{% endif %}">Admin</a>
		{% endif %}

		{% if show_comp_nav %}
			<a href="/comp/{{ comp_slug }}/competitor/{{ cid_val }}/sections"
			   class="{% if nav_active == 'sections' %}active{% endif %}">Scoring</a>

			<a href="/competitor/{{ cid_val }}/stats/my"
			   class="{% if nav_active == 'my_stats' %}active{% endif %}">My Stats</a>

			<a href="/competitor/{{ cid_val }}/stats/overall"
			   class="{% if nav_active == 'overall_stats' %}active{% endif %}">Overall Stats</a>
		{% endif %}

		<a href="/leaderboard{{ qs_str }}"
		   class="{% if nav_active == 'leaderboard' %}active{% endif %}">Leaderboard</a>

		{% if (not admin_only) and comp_slug %}
			<a class="{% if nav_active == 'doubles' %}active{% endif %}"
			   href="/comp/{{ comp_slug }}/doubles">Doubles</a>
		{% endif %}

		{% if is_logged_in or is_admin %}
			<a href="/logout">Log out</a>
		{% else %}
			<a href="/login{% if comp_slug %}?slug={{ comp_slug }}{% endif %}"
			   class="{% if nav_active == 'login' %}active{% endif %}">Log in</a>
		{% endif %}
	</nav>

	<main class="container">
		<header class="page-header">
			<h1 class="page-title">Leaderboard</h1>
			<p class="page-subtitle">
				Category: <span id="category-label">All</span>
				<span style="opacity:.55; font-weight:700;"> · </span>
				<span style="opacity:.75;">Score = top 8 climbs</span>
			</p>

			<div class="category-tabs" id="category-tabs">
				<button type="button" class="category-tab" data-cat="all">All</button>
				<button type="button" class="category-tab" data-cat="male">Male</button>
				<button type="button" class="category-tab" data-cat="female">Female</button>
				<button type="button" class="category-tab" data-cat="inclusive">Inclusive</button>
				<button type="button" class="category-tab" data-cat="doubles">Doubles</button>
			</div>
		</header>

		<div class="leaderboard-wrapper" id="lb-wrap">
			<table class="leaderboard singles" id="leaderboard-table">
				<thead id="leaderboard-head">
					<tr><th>Pos</th><th>Name</th><th>Tops</th><th>Attempts</th><th>Score</th></tr>
				</thead>
				<tbody id="leaderboard-body">
					{% if leaderboard and leaderboard|length %}
						{% for r in leaderboard %}
							<tr class="lb-main">
								<td>{{ r.position }}</td>
								<td>{{ r.name }}</td>
								<td style="text-align:center;">{{ r.tops }}</td>
								<td style="text-align:center;">{{ r.attempts_on_tops }}</td>
								<td style="text-align:center;">{{ r.total_points }}</td>
							</tr>
						{% endfor %}
					{% else %}
						<tr><td colspan="5" style="opacity:.75;">Loading…</td></tr>
					{% endif %}
				</tbody>
			</table>
		</div>

		<div class="pagination" id="pagination" hidden>
			<button type="button" class="page-btn" id="prevPage">Previous</button>
			<div class="page-info" id="pageInfo">Page 1 of 1</div>
			<button type="button" class="page-btn" id="nextPage">Next</button>
		</div>
	</main>

	<script>
		(() => {
			const CATEGORIES = [
				{ key: "all",       label: "All",              isDoubles: false },
				{ key: "male",      label: "Male",             isDoubles: false },
				{ key: "female",    label: "Female",           isDoubles: false },
				{ key: "inclusive", label: "Gender Inclusive", isDoubles: false },
				{ key: "doubles",   label: "Doubles",          isDoubles: true  },
			];

			const allowed   = new Set(CATEGORIES.map(c => c.key));
			const catByKey  = new Map(CATEGORIES.map(c => [c.key, c]));

			const tabsEl  = document.getElementById("category-tabs");
			const labelEl = document.getElementById("category-label");
			const wrapEl  = document.getElementById("lb-wrap");
			const tableEl = document.getElementById("leaderboard-table");
			const headEl  = document.getElementById("leaderboard-head");
			const bodyEl  = document.getElementById("leaderboard-body");

			const pagerEl = document.getElementById("pagination");
			const prevBtn = document.getElementById("prevPage");
			const nextBtn = document.getElementById("nextPage");
			const infoEl  = document.getElementById("pageInfo");

			const CID = "{{ cid_val }}";
			const ADMIN_ONLY = {{ 'true' if admin_only else 'false' }};
			const PER_PAGE = {{ per_page if per_page is defined else 10 }};

			let latestToken = 0;
			let aborter     = null;

			let currentKey = "all";
			let currentPage = {{ page if page is defined else 1 }};
			let currentTotalPages = {{ total_pages if total_pages is defined else 1 }};

			function escapeHtml(val) {
				return String(val ?? "")
					.replaceAll("&", "&amp;")
					.replaceAll("<", "&lt;")
					.replaceAll(">", "&gt;")
					.replaceAll('"', "&quot;")
					.replaceAll("'", "&#039;");
			}

			function applyTabState(key, isLoading) {
				const cat = catByKey.get(key) || catByKey.get("all");
				labelEl.textContent = cat.label;

				[...tabsEl.querySelectorAll(".category-tab")].forEach(btn => {
					const isActive = btn.dataset.cat === key;
					btn.classList.toggle("active", isActive);
					btn.disabled = isLoading;

					if (isActive) {
						const baseText = cat.label;
						btn.innerHTML = isLoading
							? `${escapeHtml(baseText)} <span class="loading-dot"></span>`
							: escapeHtml(baseText);
					} else {
						const original = catByKey.get(btn.dataset.cat)?.label || btn.dataset.cat;
						btn.textContent = original;
					}
				});

				if (cat.isDoubles) {
					tableEl.classList.remove("singles");
					tableEl.classList.add("doubles");
					headEl.innerHTML = `<tr><th>Pos</th><th>Team</th><th>Score</th></tr>`;
				} else {
					tableEl.classList.remove("doubles");
					tableEl.classList.add("singles");
					headEl.innerHTML = `<tr><th>Pos</th><th>Name</th><th>Tops</th><th>Attempts</th><th>Score</th></tr>`;
				}
			}

			function renderLoading(key) {
				const cat = catByKey.get(key) || catByKey.get("all");
				bodyEl.innerHTML = `<tr><td colspan="${cat.isDoubles ? 3 : 5}" style="opacity:.75;">Loading…</td></tr>`;
			}

			function detailsRowHtml(cid) {
				return `
					<tr class="lb-details" data-cid="${cid}" hidden>
						<td colspan="5">
							<div class="details-wrap">
								<div class="details-loading">Loading…</div>
								<table class="details-table" hidden>
									<thead>
										<tr>
											<th>Climb</th>
											<th>Attempts</th>
											<th>Score</th>
										</tr>
									</thead>
									<tbody></tbody>
								</table>
							</div>
						</td>
					</tr>
				`;
			}

			function renderRows(key, rows) {
				const cat = catByKey.get(key) || catByKey.get("all");

				if (!rows || !rows.length) {
					bodyEl.innerHTML = `<tr><td colspan="${cat.isDoubles ? 3 : 5}" style="opacity:.75;">${
						cat.isDoubles ? "No doubles teams yet." : "No competitors yet."
					}</td></tr>`;
					return;
				}

				if (cat.isDoubles) {
					bodyEl.innerHTML = rows.map(r => `
						<tr class="lb-main">
							<td>${escapeHtml(r.position)}</td>
							<td>${escapeHtml(r.name)}</td>
							<td>${escapeHtml(r.total_points)}</td>
						</tr>
					`).join("");
					return;
				}

				bodyEl.innerHTML = rows.map(r => {
					const cid = r.competitor_id;
					const hasCid = !!cid;

					if (!hasCid) {
						return `
							<tr class="lb-main">
								<td>${escapeHtml(r.position)}</td>
								<td>${escapeHtml(r.name)}</td>
								<td>${escapeHtml(r.tops)}</td>
								<td>${escapeHtml(r.attempts_on_tops)}</td>
								<td>${escapeHtml(r.total_points)}</td>
							</tr>
						`;
					}

					return `
						<tr class="lb-main" data-cid="${escapeHtml(cid)}">
							<td>${escapeHtml(r.position)}</td>
							<td class="name-cell">
								<button class="expander" type="button" data-cid="${escapeHtml(cid)}" aria-expanded="false">
									<span class="chev" aria-hidden="true">▸</span>
									<span class="nm">${escapeHtml(r.name)}</span>
								</button>
							</td>
							<td>${escapeHtml(r.tops)}</td>
							<td>${escapeHtml(r.attempts_on_tops)}</td>
							<td>${escapeHtml(r.total_points)}</td>
						</tr>
						${detailsRowHtml(escapeHtml(cid))}
					`;
				}).join("");
			}

			function renderError(key, msg) {
				const cat = catByKey.get(key) || catByKey.get("all");
				bodyEl.innerHTML = `<tr><td colspan="${cat.isDoubles ? 3 : 5}" style="opacity:.75;">${escapeHtml(msg)}</td></tr>`;
			}

			function setPager(page, totalPages) {
				currentPage = page || 1;
				currentTotalPages = totalPages || 1;

				const show = currentTotalPages > 1;
				pagerEl.hidden = !show;
				if (!show) return;

				infoEl.textContent = `Page ${currentPage} of ${currentTotalPages}`;
				prevBtn.disabled = currentPage <= 1;
				nextBtn.disabled = currentPage >= currentTotalPages;
			}

			function urlFor(key, page) {
				const path = (key && key !== "all") ? `/leaderboard/${encodeURIComponent(key)}` : "/leaderboard";
				const params = new URLSearchParams();
				if (CID) params.set("cid", CID);
				if (ADMIN_ONLY) params.set("admin", "1");
				if (page && page > 1) params.set("page", String(page));
				const qs = params.toString();
				return qs ? `${path}?${qs}` : path;
			}

			function initialFromUrl() {
				const parts = (location.pathname || "").split("/").filter(Boolean);
				const maybe = parts.length >= 2 ? parts[1] : "all";
				const key = allowed.has(maybe) ? maybe : "all";

				const sp = new URLSearchParams(location.search);
				const page = parseInt(sp.get("page") || "1", 10);
				return { key, page: (isNaN(page) || page < 1) ? 1 : page };
			}

			function closeAllDetails() {
				document.querySelectorAll(".lb-details").forEach(r => r.hidden = true);
				document.querySelectorAll(".expander").forEach(b => {
					b.classList.remove("open");
					b.setAttribute("aria-expanded", "false");
				});
			}

			async function loadDetails(cid) {
				const detailsRow = document.querySelector(`.lb-details[data-cid="${CSS.escape(String(cid))}"]`);
				if (!detailsRow) return;
				if (detailsRow.dataset.loaded === "1") return;

				const loading = detailsRow.querySelector(".details-loading");
				const table = detailsRow.querySelector(".details-table");
				const tbody = detailsRow.querySelector("tbody");

				loading.textContent = "Loading…";
				loading.hidden = false;
				table.hidden = true;
				tbody.innerHTML = "";

				try {
					const resp = await fetch(`/api/leaderboard/details?competitor_id=${encodeURIComponent(cid)}`, {
						method: "GET",
						cache: "no-store",
						headers: { "Accept": "application/json" },
					});
					if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
					const data = await resp.json();

					if (!data.ok) {
						loading.textContent = data.error || "Could not load details";
						return;
					}

					const climbs = data.climbs || [];
					if (!climbs.length) {
						loading.textContent = "No climbs found";
						return;
					}

					tbody.innerHTML = climbs.map(c => `
						<tr>
							<td>${escapeHtml(c.label)}</td>
							<td>${escapeHtml(c.attempts)}</td>
							<td>${escapeHtml(c.score)}</td>
						</tr>
					`).join("");

					loading.hidden = true;
					table.hidden = false;
					detailsRow.dataset.loaded = "1";
				} catch (e) {
					loading.textContent = "Error loading details";
				}
			}

			function toggleDetails(cid) {
				const btn = document.querySelector(`.expander[data-cid="${CSS.escape(String(cid))}"]`);
				const detailsRow = document.querySelector(`.lb-details[data-cid="${CSS.escape(String(cid))}"]`);
				if (!btn || !detailsRow) return;

				const isOpen = !detailsRow.hidden;

				if (isOpen) {
					detailsRow.hidden = true;
					btn.classList.remove("open");
					btn.setAttribute("aria-expanded", "false");
					return;
				}

				closeAllDetails();
				detailsRow.hidden = false;
				btn.classList.add("open");
				btn.setAttribute("aria-expanded", "true");

				loadDetails(cid);
			}

			async function load(key, page, { push = true } = {}) {
				const k = allowed.has(key) ? key : "all";
				const p = (page && page > 0) ? page : 1;

				currentKey = k;

				const token = ++latestToken;
				if (aborter) { aborter.abort(); aborter = null; }
				aborter = new AbortController();

				applyTabState(k, true);
				renderLoading(k);
				setPager(p, 1);
				wrapEl.classList.add("loading");

				if (push) history.pushState({ key: k, page: p }, "", urlFor(k, p));

				const params = new URLSearchParams({ category: k, page: String(p), per_page: String(PER_PAGE) });
				if (CID) params.set("cid", CID);
				if (ADMIN_ONLY) params.set("admin", "1");

				try {
					const resp = await fetch(`/api/leaderboard?${params}`, {
						method: "GET",
						cache: "no-store",
						signal: aborter.signal,
						headers: { "Accept": "application/json" },
					});

					if (token !== latestToken) return;
					if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

					const data = await resp.json();
					if (token !== latestToken) return;

					if (data.cat_key && data.cat_key !== k) return;

					closeAllDetails();
					renderRows(k, data.rows || []);
					setPager(data.page || p, data.total_pages || 1);

				} catch (err) {
					if (err.name === "AbortError") return;
					if (token !== latestToken) return;
					renderError(k, "Error loading leaderboard. Try again.");
					setPager(p, 1);
				} finally {
					if (token === latestToken) {
						applyTabState(k, false);
						wrapEl.classList.remove("loading");
					}
				}
			}

			tabsEl.addEventListener("click", e => {
				const btn = e.target.closest(".category-tab");
				if (!btn || btn.disabled) return;
				load(btn.dataset.cat, 1, { push: true });
			});

			bodyEl.addEventListener("click", (e) => {
				const btn = e.target.closest(".expander");
				if (!btn) return;
				if (tableEl.classList.contains("doubles")) return;

				const cid = btn.dataset.cid;
				if (!cid) return;
				toggleDetails(cid);
			});

			prevBtn.addEventListener("click", () => {
				if (currentPage <= 1) return;
				load(currentKey, currentPage - 1, { push: true });
			});

			nextBtn.addEventListener("click", () => {
				if (currentPage >= currentTotalPages) return;
				load(currentKey, currentPage + 1, { push: true });
			});

			window.addEventListener("popstate", e => {
				const state = e.state || {};
				const key = state.key || initialFromUrl().key;
				const page = state.page || initialFromUrl().page;
				load(key, page, { push: false });
			});

			const init = initialFromUrl();
			load(init.key, init.page, { push: false });
		})();
	</script>
</body>
</html>