<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>{{ competitor.name }} · Enter Scores</title>
	<link rel="stylesheet" href="/static/app.css" />
	<style>
		.map-wrapper {
			position: relative;
			max-width: 100%;
			border-radius: var(--radius-lg);
			overflow: hidden;
			box-shadow: var(--shadow-subtle);
			margin-top: 16px;
		}

		.gym-map-image {
			display: block;
			width: 100%;
			height: auto;
		}

		.map-marker {
			position: absolute;
			width: 24px;
			height: 24px;
			border-radius: 999px;
			border: 2px solid #ffffff;
			transform: translate(-50%, -50%);
			box-shadow: var(--shadow-subtle);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 0.8rem;
			font-weight: 600;
			text-decoration: none;
		}

		.map-marker.disabled {
			opacity: 0.4;
			cursor: default;
		}
	</style>
</head>

<body>
	{# Unified nav: uses session competitor as "you", nav_active for highlight #}
	{% set viewer_id = viewer_id if viewer_id is defined else session.get('competitor_id') %}
	<nav class="container top-nav">
		<div class="nav-links">
			<a
				class="back {% if nav_active == 'login' %}active{% endif %}"
				href="/login"
			>
				Login
			</a>

			{% if viewer_id %}
				<a
					class="back {% if nav_active == 'sections' %}active{% endif %}"
					href="/competitor/{{ viewer_id }}/sections"
				>
					Enter Scores
				</a>

				<a
					class="back {% if nav_active == 'my_stats' %}active{% endif %}"
					href="/competitor/{{ viewer_id }}/stats/my"
				>
					My Stats
				</a>

				<a
					class="back {% if nav_active == 'overall_stats' %}active{% endif %}"
					href="/competitor/{{ viewer_id }}/stats/overall"
				>
					Overall Stats
				</a>
			{% endif %}

			<a
				class="back {% if nav_active == 'leaderboard' %}active{% endif %}"
				href="/leaderboard{% if viewer_id %}?cid={{ viewer_id }}{% endif %}"
			>
				Leaderboard
			</a>
		</div>
	</nav>

	<main class="container">

		<!-- Unified header: same as competitor.html -->
		<header class="comp-header">
			<h1 class="comp-name">
				<span class="comp-label">Name:</span>
				<span class="comp-value">{{ competitor.name }}</span>
			</h1>

			<div class="comp-meta-row">
				<div class="comp-pill">
					<span class="comp-pill-label">Competitor</span>
					<span class="comp-pill-value">{{ competitor.id }}</span>
				</div>

				<div class="comp-pill">
					<span class="comp-pill-label">Points</span>
					<span class="comp-pill-value" id="total-points">{{ total_points }}</span>
				</div>

				{% if position is not none %}
					<div class="comp-pill">
						<span class="comp-pill-label">Position</span>
						<span class="comp-pill-value">{{ position }}</span>
					</div>
				{% endif %}
			</div>
		</header>

		{% if not can_edit %}
			<p class="view-only-note">
				You’re viewing climbs for <strong>{{ competitor.name }}</strong> in read-only mode.
				Log attempts on your own competitor page.
			</p>
		{% endif %}

		{# ===== Section toggle tabs on the main gym map page ===== #}
		{% if sections %}
			<nav class="section-tabs">
				{% for sec in sections %}
					<a
						class="section-tab"
						href="/competitor/{{ competitor.id }}/section/{{ sec.slug }}"
					>
						<span class="section-tab-title">{{ sec.name }}</span>
					</a>
				{% endfor %}
			</nav>
		{% endif %}

		<section class="card">
			<header class="section-header">
				<h2 class="section-title">Gym wall map</h2>
				<p class="comp-subtitle">
					{% if can_edit %}
						Tap a coloured dot to jump straight to that climb’s section and log your attempts.
					{% else %}
						Climbs are displayed for reference only.
					{% endif %}
				</p>
			</header>

			<div class="map-wrapper">
				<img
					src="/static/Collingwood_Gym_Map.png"
					alt="Collingwood Gym Map"
					class="gym-map-image"
				/>

				{# Markers for each climb with coords #}
				{% for c in map_climbs %}
					{% if c.x_percent is not none and c.y_percent is not none %}
						{# --- Colour mapping, same rules as competitor page --- #}
						{% set col_raw = c.colour %}
						{% if col_raw %}
							{% set lc = col_raw|lower %}
							{% if lc == "red" %}
								{% set bg = "#b32121" %}
							{% elif lc in ["white", "#fff", "#ffffff"] %}
								{% set bg = "#ffffff" %}
							{% else %}
								{% set bg = col_raw %}
							{% endif %}
						{% else %}
							{# fallback accent #}
							{% set bg = "#5df29c" %}
						{% endif %}

						{% if bg|lower in ["white", "#fff", "#ffffff"] %}
							{% set text_color = "#000000" %}
						{% else %}
							{% set text_color = "#000000" %}
						{% endif %}

						{% if can_edit %}
							<a
								class="map-marker"
								style="
									left: {{ c.x_percent }}%;
									top: {{ c.y_percent }}%;
									background: {{ bg }};
									color: {{ text_color }};
								"
								href="/competitor/{{ competitor.id }}/section/{{ c.section.slug }}#climb-{{ c.climb_number }}"
								title="{{ c.section.name }} · Climb #{{ c.climb_number }}{% if c.colour %} · {{ c.colour }}{% endif %}"
							>
								{{ c.climb_number }}
							</a>
						{% else %}
							<div
								class="map-marker disabled"
								style="
									left: {{ c.x_percent }}%;
									top: {{ c.y_percent }}%;
									background: {{ bg }};
									color: {{ text_color }};
								"
								title="{{ c.section.name }} · Climb #{{ c.climb_number }}{% if c.colour %} · {{ c.colour }}{% endif %}"
							>
								{{ c.climb_number }}
							</div>
						{% endif %}
					{% endif %}
				{% endfor %}
			</div>
		</section>
	</main>
</body>
</html>
