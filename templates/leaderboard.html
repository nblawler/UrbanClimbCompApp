<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Leaderboard ¬∑ Urban Climb Comp</title>
	<link rel="stylesheet" href="/static/app.css" />
</head>
<body>
	<nav class="container top-nav">
		<div class="brand">
			<span class="brand-mark">üßó‚Äç‚ôÇÔ∏è</span>
			<span class="brand-name">Urban Climb Comp</span>
		</div>
		<div class="nav-links">
			<a class="back" href="/">Home</a>
		</div>
	</nav>

	<main class="container">

		<header class="header" style="margin-bottom: 12px; flex-direction:column; align-items:flex-start; gap:8px;">
			<div>
				<h1 style="margin:0; font-size:1.8rem;">
					Leaderboard
				</h1>
				<p style="margin:4px 0 0; color:var(--muted);">
					Category:
					<span id="category-label">{{ category }}</span>
				</p>
			</div>

			<!-- Category tabs (All + Male + Female + Inclusive) -->
			<div class="section-tabs">
				<a
					href="/leaderboard"
					class="section-tab{% if category == 'All' %} active{% endif %}"
				>
					<span class="section-tab-title">All</span>
				</a>

				<a
					href="/leaderboard/male"
					class="section-tab{% if category == 'Male' %} active{% endif %}"
				>
					<span class="section-tab-title">Male</span>
				</a>

				<a
					href="/leaderboard/female"
					class="section-tab{% if category == 'Female' %} active{% endif %}"
				>
					<span class="section-tab-title">Female</span>
				</a>

				<a
					href="/leaderboard/inclusive"
					class="section-tab{% if category == 'Gender Inclusive' %} active{% endif %}"
				>
					<span class="section-tab-title">Inclusive</span>
				</a>
			</div>
		</header>

		<table class="leaderboard">
			<thead>
				<tr>
					<th>Pos</th>
					<th>Competitor</th>
					<th>Gender</th>
					<th>Tops</th>
					<th>Attempts on tops</th>
					<th>Points</th>
					<th>Last update</th>
				</tr>
			</thead>
			<tbody id="leaderboard-body">
				{# Initial server-rendered rows so page works without JS #}
				{% for row in leaderboard %}
					<tr>
						<td>{{ row.position }}</td>
						<td>{{ row.name }}</td>  {# no link, just text #}
						<td>{{ row.gender }}</td>
						<td>{{ row.tops }}</td>
						<td>{{ row.attempts_on_tops }}</td>
						<td>{{ row.total_points }}</td>
						<td>
							{% if row.last_update %}
								{{ row.last_update.strftime("%H:%M:%S") }}
							{% else %}
								‚Äì
							{% endif %}
						</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>

	</main>

	<script>
		const leaderboardBody = document.getElementById("leaderboard-body");

		function getCategoryFromPath() {
			// /leaderboard              -> null (means "All")
			// /leaderboard/male         -> "male"
			// /leaderboard/female       -> "female"
			// /leaderboard/inclusive    -> "inclusive"
			const parts = window.location.pathname.split("/").filter(Boolean);
			if (parts.length >= 2 && parts[0] === "leaderboard") {
				return parts[1];
			}
			return null;
		}

		async function refreshLeaderboard() {
			if (!leaderboardBody) return;

			const categoryFromPath = getCategoryFromPath();
			let url = "/api/leaderboard";
			if (categoryFromPath) {
				url += "?category=" + encodeURIComponent(categoryFromPath);
			}

			try {
				const res = await fetch(url, { cache: "no-store" });
				if (!res.ok) return;

				const data = await res.json();
				const rows = data.rows || [];

				const frag = document.createDocumentFragment();

				rows.forEach((r) => {
					const tr = document.createElement("tr");

					// Position
					const tdPos = document.createElement("td");
					tdPos.textContent = r.position;
					tr.appendChild(tdPos);

					// Name (no link ‚Äì read-only)
					const tdName = document.createElement("td");
					tdName.textContent = r.name;
					tr.appendChild(tdName);

					// Gender
					const tdGender = document.createElement("td");
					tdGender.textContent = r.gender;
					tr.appendChild(tdGender);

					// Tops
					const tdTops = document.createElement("td");
					tdTops.textContent = r.tops;
					tr.appendChild(tdTops);

					// Attempts on tops
					const tdAttempts = document.createElement("td");
					tdAttempts.textContent = r.attempts_on_tops;
					tr.appendChild(tdAttempts);

					// Points
					const tdPoints = document.createElement("td");
					tdPoints.textContent = r.total_points;
					tr.appendChild(tdPoints);

					// Last update
					const tdUpdate = document.createElement("td");
					if (r.last_update) {
						const d = new Date(r.last_update);
						tdUpdate.textContent = d.toLocaleTimeString();
					} else {
						tdUpdate.textContent = "‚Äì";
					}
					tr.appendChild(tdUpdate);

					frag.appendChild(tr);
				});

				leaderboardBody.innerHTML = "";
				leaderboardBody.appendChild(frag);

				// Update the category label text from API if present
				const catLabel = document.getElementById("category-label");
				if (catLabel && data.category) {
					catLabel.textContent = data.category;
				}
			} catch (e) {
				// ignore errors ‚Äì this is display only
			}
		}

		// Initial load + poll every 5 seconds
		refreshLeaderboard();
		setInterval(refreshLeaderboard, 5000);
	</script>
</body>
</html>

