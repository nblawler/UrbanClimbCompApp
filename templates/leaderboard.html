<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Leaderboard Â· Urban Climb Comp</title>
	<link rel="stylesheet" href="/static/app.css" />
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background: linear-gradient(135deg, #0a1628 0%, #1a2942 100%);
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			color: #fff;
		}

		/* Top nav */
		.nav {
			padding: 1.25rem 2rem;
			display: flex;
			gap: 1.5rem;
			align-items: center;
			flex-wrap: wrap;
		}

		.nav a {
			color: rgba(255, 255, 255, 0.7);
			text-decoration: none;
			font-size: 0.95rem;
			transition: color 0.2s;
			font-weight: 600;
		}

		.nav a.active { color: #5df4a2; font-weight: 800; }
		.nav a:hover { color: #fff; }

		/* Container */
		.container {
			flex: 1;
			max-width: 1200px;
			margin: 0 auto;
			padding: 2rem;
			width: 100%;
		}

		/* Header */
		.page-header { margin-bottom: 2rem; }

		.page-title {
			font-size: 2.5rem;
			font-weight: 900;
			margin-bottom: 0.75rem;
			background: linear-gradient(135deg, #fff 0%, #5df4a2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			letter-spacing: -0.02em;
		}

		.page-subtitle {
			font-size: 1.1rem;
			color: rgba(255, 255, 255, 0.75);
			margin-bottom: 1.5rem;
		}

		.page-subtitle span { color: #5df4a2; font-weight: 800; }

		/* Category tabs */
		.category-tabs {
			display: flex;
			gap: 0.75rem;
			flex-wrap: wrap;
		}

		.category-tab {
			padding: 0.75rem 1.5rem;
			border-radius: 999px;
			border: 2px solid rgba(255, 255, 255, 0.2);
			background: rgba(255, 255, 255, 0.05);
			color: rgba(255, 255, 255, 0.85);
			text-decoration: none;
			font-size: 0.95rem;
			font-weight: 800;
			transition: all 0.2s;
			display: inline-block;
		}

		.category-tab:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: rgba(255, 255, 255, 0.4);
			transform: translateY(-1px);
		}

		.category-tab.active {
			background: #5df4a2;
			color: #0a1628;
			border-color: #5df4a2;
			transform: translateY(-1px);
			box-shadow: 0 10px 20px rgba(93, 244, 162, 0.3);
		}

		/* Leaderboard table wrapper */
		.leaderboard-wrapper {
			background: rgba(255, 255, 255, 0.05);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 1.5rem;
			overflow: hidden;
		}

		.leaderboard {
			width: 100%;
			border-collapse: collapse;
		}

		.leaderboard thead th {
			text-align: left;
			font-weight: 800;
			padding: 1.25rem 1.5rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			color: rgba(255, 255, 255, 0.7);
			font-size: 0.9rem;
			letter-spacing: 0.05em;
			text-transform: uppercase;
			background: rgba(255, 255, 255, 0.02);
		}

		.leaderboard tbody td {
			padding: 1.25rem 1.5rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			color: #fff;
			font-size: 1rem;
		}

		.leaderboard tbody tr { transition: background 0.15s; }
		.leaderboard tbody tr:hover { background: rgba(255, 255, 255, 0.05); }

		/* Top 3 highlighting */
		#leaderboard-body tr:nth-child(1) { background: rgba(255, 215, 0, 0.08); border-left: 4px solid #FFD700; }
		#leaderboard-body tr:nth-child(1):hover { background: rgba(255, 215, 0, 0.12); }

		#leaderboard-body tr:nth-child(2) { background: rgba(192, 192, 192, 0.08); border-left: 4px solid #C0C0C0; }
		#leaderboard-body tr:nth-child(2):hover { background: rgba(192, 192, 192, 0.12); }

		#leaderboard-body tr:nth-child(3) { background: rgba(205, 127, 50, 0.08); border-left: 4px solid #CD7F32; }
		#leaderboard-body tr:nth-child(3):hover { background: rgba(205, 127, 50, 0.12); }

		/* Position column */
		.leaderboard tbody td:first-child { font-weight: 950; font-size: 1.1rem; }

		/* Center numeric columns (singles layout) */
		.leaderboard.singles th:nth-child(3),
		.leaderboard.singles td:nth-child(3),
		.leaderboard.singles th:nth-child(4),
		.leaderboard.singles td:nth-child(4),
		.leaderboard.singles th:nth-child(5),
		.leaderboard.singles td:nth-child(5) {
			text-align: center;
		}

		/* Center points column on doubles layout */
		.leaderboard.doubles th:nth-child(3),
		.leaderboard.doubles td:nth-child(3) {
			text-align: center;
		}

		/* Links */
		.leaderboard a {
			color: #5df4a2;
			text-decoration: none;
			font-weight: 700;
			transition: color 0.2s;
		}
		.leaderboard a:hover { color: #7fffa4; text-decoration: underline; }

		/* Responsive */
		@media (max-width: 768px) {
			.nav { padding: 1rem; }
			.container { padding: 1.5rem 1rem; }
			.page-title { font-size: 2rem; }
			.page-subtitle { font-size: 1rem; }

			.leaderboard thead th,
			.leaderboard tbody td {
				padding: 1rem 0.75rem;
				font-size: 0.9rem;
			}

			/* Hide attempts column on mobile (singles only) */
			.leaderboard.singles thead th:nth-child(4),
			.leaderboard.singles tbody td:nth-child(4) {
				display: none;
			}
		}
	</style>
</head>

<body>
	{% set is_logged_in = session.get('account_id') %}
	{% set viewer_id = session.get('competitor_id') %}
	{% set is_admin = session.get('admin_ok', False) %}
	{% set comp_slug = comp_slug if comp_slug is defined else session.get('active_comp_slug') %}

	{# IMPORTANT: cid must persist across category clicks; do NOT depend on show_comp_nav/account_id #}
	{% set cid = request.args.get('cid') %}
	{% set cid_val = (cid if cid else (viewer_id if viewer_id else None)) %}
	{% set show_comp_nav = (cid_val is not none and comp_slug) %}

	{# Derive a stable category key from the label you already pass (NO backend change needed) #}
	{% set cat_label = (category or 'All') %}
	{% set cat_key = 'all' %}
	{% if cat_label == 'Male' %}
		{% set cat_key = 'male' %}
	{% elif cat_label == 'Female' %}
		{% set cat_key = 'female' %}
	{% elif cat_label == 'Gender Inclusive' %}
		{% set cat_key = 'inclusive' %}
	{% elif cat_label == 'Doubles' %}
		{% set cat_key = 'doubles' %}
	{% else %}
		{% set cat_key = 'all' %}
	{% endif %}

	<nav class="nav">
		<a href="{% if is_logged_in or is_admin %}/my-comps{% else %}/{% endif %}"
		   class="{% if nav_active == 'my_comps' %}active{% endif %}">Home</a>

		{% if is_admin %}
			<a href="/admin/comps" class="{% if nav_active == 'admin' %}active{% endif %}">Admin</a>
		{% endif %}

		{% if show_comp_nav %}
			<a href="/comp/{{ comp_slug }}/competitor/{{ cid_val }}/sections"
			   class="{% if nav_active == 'sections' %}active{% endif %}">Scoring</a>

			<a href="/competitor/{{ cid_val }}/stats/my"
			   class="{% if nav_active == 'my_stats' %}active{% endif %}">My Stats</a>

			<a href="/competitor/{{ cid_val }}/stats/overall"
			   class="{% if nav_active == 'overall_stats' %}active{% endif %}">Overall Stats</a>
		{% endif %}

		<a href="/leaderboard{% if cid_val %}?cid={{ cid_val }}{% endif %}"
		   class="{% if nav_active == 'leaderboard' %}active{% endif %}">Leaderboard</a>

		{% if comp_slug %}
			<a class="{% if nav_active == 'doubles' %}active{% endif %}"
			   href="/comp/{{ comp_slug }}/doubles">Doubles</a>
		{% endif %}

		{% if is_logged_in or is_admin %}
			<a href="/logout">Log out</a>
		{% else %}
			<a href="/login{% if comp_slug %}?slug={{ comp_slug }}{% endif %}"
			   class="{% if nav_active == 'login' %}active{% endif %}">Log in</a>
		{% endif %}
	</nav>

	<main class="container" data-category-key="{{ cat_key }}">
		<header class="page-header">
			<h1 class="page-title">Leaderboard</h1>
			<p class="page-subtitle">
				Category: <span id="category-label">{{ category }}</span>
			</p>

			<div class="category-tabs">
				<a href="/leaderboard{% if cid_val %}?cid={{ cid_val }}{% endif %}"
				   class="category-tab{% if category == 'All' %} active{% endif %}">All</a>

				<a href="/leaderboard/male{% if cid_val %}?cid={{ cid_val }}{% endif %}"
				   class="category-tab{% if category == 'Male' %} active{% endif %}">Male</a>

				<a href="/leaderboard/female{% if cid_val %}?cid={{ cid_val }}{% endif %}"
				   class="category-tab{% if category == 'Female' %} active{% endif %}">Female</a>

				<a href="/leaderboard/inclusive{% if cid_val %}?cid={{ cid_val }}{% endif %}"
				   class="category-tab{% if category == 'Gender Inclusive' %} active{% endif %}">Inclusive</a>

				<a href="/leaderboard/doubles{% if cid_val %}?cid={{ cid_val }}{% endif %}"
				   class="category-tab{% if category == 'Doubles' %} active{% endif %}">Doubles</a>
			</div>
		</header>

		<div class="leaderboard-wrapper">
			<table id="leaderboard-table" class="leaderboard {% if category == 'Doubles' %}doubles{% else %}singles{% endif %}">
				<thead id="leaderboard-head">
					{% if category == 'Doubles' %}
						<tr>
							<th>Pos</th>
							<th>Team</th>
							<th>Points</th>
						</tr>
					{% else %}
						<tr>
							<th>Pos</th>
							<th>Competitor</th>
							<th>Tops</th>
							<th>Attempts</th>
							<th>Points</th>
						</tr>
					{% endif %}
				</thead>

				<tbody id="leaderboard-body">
					{% if category == 'Doubles' %}
						{% if leaderboard %}
							{% for t in leaderboard %}
								<tr>
									<td>{{ t.position }}</td>
									<td>{{ t.name }}</td>
									<td>{{ t.total_points }}</td>
								</tr>
							{% endfor %}
						{% else %}
							<tr><td colspan="3" style="opacity:.75;">No doubles teams yet.</td></tr>
						{% endif %}
					{% else %}
						{% for row in leaderboard %}
							<tr>
								<td>{{ row.position }}</td>
								<td>
									{% if current_competitor_id and row.competitor_id == current_competitor_id %}
										<span>{{ row.name }}</span>
									{% else %}
										<a href="/competitor/{{ row.competitor_id }}/stats/climber">{{ row.name }}</a>
									{% endif %}
								</td>
								<td>{{ row.tops }}</td>
								<td>{{ row.attempts_on_tops }}</td>
								<td>{{ row.total_points }}</td>
							</tr>
						{% endfor %}
					{% endif %}
				</tbody>
			</table>
		</div>
	</main>

	<script>
		(() => {
			const leaderboardBody = document.getElementById("leaderboard-body");
			const leaderboardHead = document.getElementById("leaderboard-head");
			const leaderboardTable = document.getElementById("leaderboard-table");
			const catLabel = document.getElementById("category-label");

			const viewerId = {{ current_competitor_id if current_competitor_id is not none else 'null' }};

			// Canonical category key from server-rendered HTML (stable)
			const main = document.querySelector("main.container");
			let categoryKey = (main && main.dataset && main.dataset.categoryKey) ? main.dataset.categoryKey : "all";
			categoryKey = String(categoryKey || "all").trim().toLowerCase();

			let isUnloading = false;
			window.addEventListener("beforeunload", () => { isUnloading = true; });

			function setSinglesHeader() {
				leaderboardHead.innerHTML = `
					<tr>
						<th>Pos</th>
						<th>Competitor</th>
						<th>Tops</th>
						<th>Attempts</th>
						<th>Points</th>
					</tr>
				`;
				leaderboardTable.classList.remove("doubles");
				leaderboardTable.classList.add("singles");
			}

			function setDoublesHeader() {
				leaderboardHead.innerHTML = `
					<tr>
						<th>Pos</th>
						<th>Team</th>
						<th>Points</th>
					</tr>
				`;
				leaderboardTable.classList.remove("singles");
				leaderboardTable.classList.add("doubles");
			}

			function renderSingles(rows) {
				const frag = document.createDocumentFragment();

				(rows || []).forEach((r) => {
					const tr = document.createElement("tr");

					const tdPos = document.createElement("td");
					tdPos.textContent = (r.position ?? "");
					tr.appendChild(tdPos);

					const tdName = document.createElement("td");
					if (viewerId !== null && r.competitor_id === viewerId) {
						tdName.textContent = (r.name ?? "");
					} else {
						const a = document.createElement("a");
						a.href = `/competitor/${r.competitor_id}/stats/climber`;
						a.textContent = (r.name ?? "");
						tdName.appendChild(a);
					}
					tr.appendChild(tdName);

					const tdTops = document.createElement("td");
					tdTops.textContent = (r.tops ?? "");
					tr.appendChild(tdTops);

					const tdAttempts = document.createElement("td");
					tdAttempts.textContent = (r.attempts_on_tops ?? "");
					tr.appendChild(tdAttempts);

					const tdPoints = document.createElement("td");
					tdPoints.textContent = (r.total_points ?? "");
					tr.appendChild(tdPoints);

					frag.appendChild(tr);
				});

				leaderboardBody.innerHTML = "";
				leaderboardBody.appendChild(frag);
			}

			function renderDoubles(rows) {
				const frag = document.createDocumentFragment();

				if (!rows || rows.length === 0) {
					const tr = document.createElement("tr");
					const td = document.createElement("td");
					td.colSpan = 3;
					td.style.opacity = "0.75";
					td.textContent = "No doubles teams yet.";
					tr.appendChild(td);
					frag.appendChild(tr);

					leaderboardBody.innerHTML = "";
					leaderboardBody.appendChild(frag);
					return;
				}

				(rows || []).forEach((t) => {
					const tr = document.createElement("tr");

					const tdPos = document.createElement("td");
					tdPos.textContent = (t.position ?? "");
					tr.appendChild(tdPos);

					const tdTeam = document.createElement("td");
					tdTeam.textContent = t.name || `${t.a_name || ""} + ${t.b_name || ""}`.trim();
					tr.appendChild(tdTeam);

					const tdPts = document.createElement("td");
					tdPts.textContent = (t.total_points ?? "");
					tr.appendChild(tdPts);

					frag.appendChild(tr);
				});

				leaderboardBody.innerHTML = "";
				leaderboardBody.appendChild(frag);
			}

			async function refreshLeaderboard() {
				if (isUnloading) return;
				if (!leaderboardBody || !leaderboardHead || !leaderboardTable) return;

				let url = "/api/leaderboard";
				if (categoryKey && categoryKey !== "all") {
					url += "?category=" + encodeURIComponent(categoryKey);
				}

				try {
					const res = await fetch(url, { cache: "no-store" });
					if (!res.ok) return;

					const data = await res.json();

					// Update label from API, but DO NOT change categoryKey here
					if (catLabel && data.category) catLabel.textContent = data.category;

					const apiLabel = String(data.category || "").trim().toLowerCase();
					const isDoubles = (categoryKey === "doubles") || (apiLabel === "doubles");

					if (isDoubles) {
						setDoublesHeader();
						renderDoubles(data.rows || []);
					} else {
						setSinglesHeader();
						renderSingles(data.rows || []);
					}
				} catch (e) {
					// swallow errors to avoid flicker
				}
			}

			refreshLeaderboard();
			const intervalId = setInterval(refreshLeaderboard, 5000);
			window.addEventListener("beforeunload", () => clearInterval(intervalId));
		})();
	</script>
</body>
</html>
