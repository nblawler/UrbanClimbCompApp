<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Leaderboard Â· Urban Climb Comp</title>
	<link rel="stylesheet" href="/static/app.css" />
</head>
<body>
	{% set viewer_id = viewer_id if viewer_id is defined else session.get('competitor_id') %}
	<nav class="container top-nav">
		<div class="nav-links">
			<a
				class="back {% if nav_active == 'login' %}active{% endif %}"
				href="/login"
			>
				Login
			</a>

			{% if viewer_id %}
				<a
					class="back {% if nav_active == 'sections' %}active{% endif %}"
					href="/competitor/{{ viewer_id }}/sections"
				>
					Enter Scores
				</a>

				<a
					class="back {% if nav_active == 'my_stats' %}active{% endif %}"
					href="/competitor/{{ viewer_id }}/stats/my"
				>
					My Stats
				</a>

				<a
					class="back {% if nav_active == 'overall_stats' %}active{% endif %}"
					href="/competitor/{{ viewer_id }}/stats/overall"
				>
					Overall Stats
				</a>
			{% endif %}

			<a
				class="back {% if nav_active == 'leaderboard' %}active{% endif %}"
				href="/leaderboard{% if viewer_id %}?cid={{ viewer_id }}{% endif %}"
			>
				Leaderboard
			</a>
		</div>
	</nav>

	<main class="container">

		<header class="header" style="margin-bottom: 12px; flex-direction:column; align-items:flex-start; gap:8px;">
			<div>
				<h1 style="margin:0; font-size:1.8rem;">
					Leaderboard
				</h1>
				<p style="margin:4px 0 0; color:var(--muted);">
					Category:
					<span id="category-label">{{ category }}</span>
				</p>
			</div>

			<!-- Category tabs (All + Male + Female + Inclusive) -->
			<div class="section-tabs" style="margin-top:6px;">
				<a
					href="/leaderboard{% if viewer_id %}?cid={{ viewer_id }}{% endif %}"
					class="section-tab{% if category == 'All' %} active{% endif %}"
				>
					<span class="section-tab-title">All</span>
				</a>

				<a
					href="/leaderboard/male{% if viewer_id %}?cid={{ viewer_id }}{% endif %}"
					class="section-tab{% if category == 'Male' %} active{% endif %}"
				>
					<span class="section-tab-title">Male</span>
				</a>

				<a
					href="/leaderboard/female{% if viewer_id %}?cid={{ viewer_id }}{% endif %}"
					class="section-tab{% if category == 'Female' %} active{% endif %}"
				>
					<span class="section-tab-title">Female</span>
				</a>

				<a
					href="/leaderboard/inclusive{% if viewer_id %}?cid={{ viewer_id }}{% endif %}"
					class="section-tab{% if category == 'Gender Inclusive' %} active{% endif %}"
				>
					<span class="section-tab-title">Inclusive</span>
				</a>
			</div>
		</header>

		<!-- Scrollable wrapper so the leaderboard never overflows the page -->
		<div class="stats-table-wrapper" style="margin-top:4px;">
			<table class="leaderboard">
				<thead>
					<tr>
						<th>Pos</th>
						<th>Competitor</th>
						<th>Tops</th>
						<th>Attempts</th>
						<th>Points</th>
					</tr>
				</thead>
				<tbody id="leaderboard-body">
					{# Initial server-rendered rows so page works without JS #}
					{% for row in leaderboard %}
						<tr>
							<td>{{ row.position }}</td>
							<td>
								{% if current_competitor_id and row.competitor_id == current_competitor_id %}
									<a href="/competitor/{{ row.competitor_id }}/stats">
										{{ row.name }}
									</a>
								{% else %}
									<a href="/competitor/{{ row.competitor_id }}/stats?view=public">
										{{ row.name }}
									</a>
								{% endif %}
							</td>
							<td>{{ row.tops }}</td>
							<td>{{ row.attempts_on_tops }}</td>
							<td>{{ row.total_points }}</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

	</main>

	<script>
		const leaderboardBody = document.getElementById("leaderboard-body");

		function getCategoryFromPath() {
			const parts = window.location.pathname.split("/").filter(Boolean);
			if (parts.length >= 2 && parts[0] === "leaderboard") {
				return parts[1];
			}
			return null;
		}

		async function refreshLeaderboard() {
			if (!leaderboardBody) return;

			const categoryFromPath = getCategoryFromPath();
			let url = "/api/leaderboard";
			if (categoryFromPath) {
				url += "?category=" + encodeURIComponent(categoryFromPath);
			}

			try {
				const res = await fetch(url, { cache: "no-store" });
				if (!res.ok) return;

				const data = await res.json();
				const rows = data.rows || [];
				const frag = document.createDocumentFragment();

				rows.forEach((r) => {
					const tr = document.createElement("tr");

					const tdPos = document.createElement("td");
					tdPos.textContent = r.position;
					tr.appendChild(tdPos);

					const tdName = document.createElement("td");
					// JS refresh uses public view links so no one accidentally gets edit access
					const a = document.createElement("a");
					a.href = `/competitor/${r.competitor_id}/stats?view=public`;
					a.textContent = r.name;
					tdName.appendChild(a);
					tr.appendChild(tdName);

					const tdTops = document.createElement("td");
					tdTops.textContent = r.tops;
					tr.appendChild(tdTops);

					const tdAttempts = document.createElement("td");
					tdAttempts.textContent = r.attempts_on_tops;
					tr.appendChild(tdAttempts);

					const tdPoints = document.createElement("td");
					tdPoints.textContent = r.total_points;
					tr.appendChild(tdPoints);

					frag.appendChild(tr);
				});

				leaderboardBody.innerHTML = "";
				leaderboardBody.appendChild(frag);

				const catLabel = document.getElementById("category-label");
				if (catLabel && data.category) {
					catLabel.textContent = data.category;
				}
			} catch (e) {
				// display-only error; ignore
			}
		}

		// Initial load + poll every 5 seconds
		refreshLeaderboard();
		setInterval(refreshLeaderboard, 5000);
	</script>
</body>
</html>
