<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Leaderboard Â· Urban Climb Comp</title>
	<link rel="stylesheet" href="/static/app.css" />
</head>
<body>
	<nav class="container top-nav">
		<div class="nav-links">
			{% if competitor %}
				<a class="back" href="/leaderboard?cid={{ competitor.id }}">Leaderboard</a>
				<a class="back" href="/competitor/{{ competitor.id }}/sections">Sections</a>
				<a class="back" href="/competitor/{{ competitor.id }}/stats">Stats</a>
			{% else %}
				<a class="back" href="/leaderboard">Leaderboard</a>
			{% endif %}
		</div>
	</nav>

	<main class="container">

		<header class="header" style="margin-bottom: 12px; flex-direction:column; align-items:flex-start; gap:8px;">
			<div>
				<h1 style="margin:0; font-size:1.8rem;">
					Leaderboard
				</h1>
				<p style="margin:4px 0 0; color:var(--muted);">
					Category:
					<span id="category-label">{{ category }}</span>
				</p>
			</div>

			<!-- Category tabs (All + Male + Female + Inclusive) -->
			<div class="section-tabs" style="margin-top:6px;">
				<a
					href="/leaderboard{% if competitor %}?cid={{ competitor.id }}{% endif %}"
					class="section-tab{% if category == 'All' %} active{% endif %}"
				>
					<span class="section-tab-title">All</span>
				</a>

				<a
					href="/leaderboard/male{% if competitor %}?cid={{ competitor.id }}{% endif %}"
					class="section-tab{% if category == 'Male' %} active{% endif %}"
				>
					<span class="section-tab-title">Male</span>
				</a>

				<a
					href="/leaderboard/female{% if competitor %}?cid={{ competitor.id }}{% endif %}"
					class="section-tab{% if category == 'Female' %} active{% endif %}"
				>
					<span class="section-tab-title">Female</span>
				</a>

				<a
					href="/leaderboard/inclusive{% if competitor %}?cid={{ competitor.id }}{% endif %}"
					class="section-tab{% if category == 'Gender Inclusive' %} active{% endif %}"
				>
					<span class="section-tab-title">Inclusive</span>
				</a>
			</div>
		</header>

		<!-- Wrapper so leaderboard fills the screen nicely and scrolls horizontally if needed -->
		<div class="leaderboard-wrapper">
			<div class="stats-table-wrapper" style="margin-top:4px;">
				<table class="leaderboard">
					<thead>
						<tr>
							<th>Pos</th>
							<th>Competitor</th>
							<th>Tops</th>
							<th>Attempts</th>
							<th>Points</th>
						</tr>
					</thead>
					<tbody id="leaderboard-body">
						{# Initial server-rendered rows so page works without JS #}
						{% for row in leaderboard %}
							<tr>
								<td>{{ row.position }}</td>
								<td>
									<a href="/competitor/{{ row.competitor_id }}/stats">
										{{ row.name }}
									</a>
								</td>
								<td>{{ row.tops }}</td>
								<td>{{ row.attempts_on_tops }}</td>
								<td>{{ row.total_points }}</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>

	</main>

	<script>
		const leaderboardBody = document.getElementById("leaderboard-body");

		function getCategoryFromPath() {
			const parts = window.location.pathname.split("/").filter(Boolean);
			if (parts.length >= 2 && parts[0] === "leaderboard") {
				return parts[1];
			}
			return null;
		}

		async function refreshLeaderboard() {
			if (!leaderboardBody) return;

			const categoryFromPath = getCategoryFromPath();
			let url = "/api/leaderboard";
			if (categoryFromPath) {
				url += "?category=" + encodeURIComponent(categoryFromPath);
			}

			try {
				const res = await fetch(url, { cache: "no-store" });
				if (!res.ok) return;

				const data = await res.json();
				const rows = data.rows || [];
				const frag = document.createDocumentFragment();

				rows.forEach((r) => {
					const tr = document.createElement("tr");

					// Pos
					const tdPos = document.createElement("td");
					tdPos.textContent = r.position;
					tr.appendChild(tdPos);

					// Name (clickable to competitor stats)
					const tdName = document.createElement("td");
					const link = document.createElement("a");
					link.href = `/competitor/${r.competitor_id}/stats`;
					link.textContent = r.name;
					tdName.appendChild(link);
					tr.appendChild(tdName);

					// Tops
					const tdTops = document.createElement("td");
					tdTops.textContent = r.tops;
					tr.appendChild(tdTops);

					// Attempts on tops
					const tdAttempts = document.createElement("td");
					tdAttempts.textContent = r.attempts_on_tops;
					tr.appendChild(tdAttempts);

					// Points
					const tdPoints = document.createElement("td");
					tdPoints.textContent = r.total_points;
					tr.appendChild(tdPoints);

					frag.appendChild(tr);
				});

				leaderboardBody.innerHTML = "";
				leaderboardBody.appendChild(frag);

				const catLabel = document.getElementById("category-label");
				if (catLabel && data.category) {
					catLabel.textContent = data.category;
				}
			} catch (e) {
				// display-only
			}
		}

		// Initial load + poll every 5 seconds
		refreshLeaderboard();
		setInterval(refreshLeaderboard, 5000);
	</script>
</body>
</html>
