<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Climb {{ climb_number }} ¬∑ Stats</title>
	<link rel="stylesheet" href="/static/app.css" />
</head>
<body>
	<nav class="container top-nav">
		<div class="brand">
			<span class="brand-mark">üßó‚Äç‚ôÇÔ∏è</span>
			<span class="brand-name">Urban Climb Comp</span>
		</div>
		<div class="nav-links">
			<a class="back" href="/">Home</a>
			<a class="back" href="/leaderboard">Leaderboard</a>
			<a class="back" href="javascript:history.back()">Stats</a>
		</div>
	</nav>

	<main class="container">

		<header class="header" style="margin-bottom: 16px;">
			<h1 style="margin:0 0 4px 0; font-size:1.9rem;">
				Climb #{{ climb_number }} Stats
			</h1>
		</header>

		{% if not has_config %}
			<section class="stats-card">
				<p style="margin:0;">
					This climb is not configured in any section.
				</p>
			</section>
		{% else %}

			<section class="stats-card">
				<h2 class="stats-title">Overview</h2>

				<p style="margin: 0 0 6px 0; font-size:0.95rem; color:var(--muted);">
					Sections:
					{% if sections %}
						{% for s in sections %}
							<span>{{ s.name }}</span>{% if not loop.last %}, {% endif %}
						{% endfor %}
					{% else %}
						Unknown
					{% endif %}
				</p>

				<table class="stats-table">
					<tbody>
						<tr>
							<th>Total competitors who logged this climb</th>
							<td>{{ num_competitors }}</td>
						</tr>
						<tr>
							<th>Total attempts</th>
							<td>{{ total_attempts }}</td>
						</tr>
						<tr>
							<th>Tops</th>
							<td>{{ tops }}</td>
						</tr>
						<tr>
							<th>Flashes (topped on first attempt)</th>
							<td>{{ flashes }}</td>
						</tr>
						<tr>
							<th>Top rate</th>
							<td>
								{% if num_competitors %}
									{{ (top_rate * 100) | round(1) }}%
								{% else %}
									‚Äì
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Flash rate</th>
							<td>
								{% if num_competitors %}
									{{ (flash_rate * 100) | round(1) }}%
								{% else %}
									‚Äì
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Avg attempts per competitor</th>
							<td>
								{% if num_competitors %}
									{{ avg_attempts_per_comp | round(2) }}
								{% else %}
									‚Äì
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Avg attempts on topped climbs</th>
							<td>
								{% if tops %}
									{{ avg_attempts_on_tops | round(2) }}
								{% else %}
									‚Äì
								{% endif %}
							</td>
						</tr>
					</tbody>
				</table>
			</section>

			<section class="stats-card">
				<h2 class="stats-title">Per-Competitor Breakdown</h2>

				{% if per_competitor %}
					{% set total_rows = per_competitor|length %}
					{% set default_limit = 10 %}

					<div
						id="per-comp-controls"
						style="
							display:flex;
							flex-wrap:wrap;
							gap:8px 16px;
							justify-content:space-between;
							align-items:center;
							margin:8px 0 10px;
						"
					>
						<p style="margin:0; font-size:0.85rem; color:var(--muted);">
							Competitors logged: {{ total_rows }}
							{% if total_rows > default_limit %}
								¬∑ showing top {{ default_limit }} by default
							{% endif %}
						</p>

						<div style="display:flex; flex-wrap:wrap; gap:8px 12px; align-items:center;">
							<label style="display:inline-flex; align-items:center; gap:6px; font-size:0.85rem;">
								<input type="checkbox" id="filter-topped" />
								<span>Only topped</span>
							</label>

							<label style="display:inline-flex; align-items:center; gap:6px; font-size:0.85rem;">
								<input type="checkbox" id="filter-flashed" />
								<span>Only flashes</span>
							</label>

							{% if total_rows > default_limit %}
								<button
									id="toggle-rows-btn"
									type="button"
									class="primary"
									style="padding:6px 10px; font-size:0.85rem;"
								>
									Show all ({{ total_rows }})
								</button>
							{% endif %}
						</div>
					</div>

					<div style="max-height:70vh; overflow:auto; border-radius:10px;">
						<table class="stats-table">
							<thead>
								<tr>
									<th>Competitor</th>
									<th>Attempts</th>
									<th>Status</th>
									<th>Points</th>
								</tr>
							</thead>
							<tbody id="per-comp-body">
								{% for row in per_competitor %}
									{# data attributes: topped and flash flags #}
									<tr
										class="comp-row"
										data-topped="{{ 1 if row.topped else 0 }}"
										data-flash="{{ 1 if row.topped and row.attempts == 1 else 0 }}"
									>
										<td>
											{{ row.name }} ( #{{ row.competitor_id }} )
										</td>
										<td>{{ row.attempts }}</td>
										<td>
											{% if row.topped %}
												{% if row.attempts == 1 %}
													Flashed
												{% else %}
													Topped
												{% endif %}
											{% else %}
												Not topped
											{% endif %}
										</td>
										<td>{{ row.points }}</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>

				{% else %}
					<p style="margin:0; color:var(--muted);">
						No competitors have logged attempts on this climb yet.
					</p>
				{% endif %}
			</section>

		{% endif %}

	</main>

	{% if per_competitor and per_competitor|length > 0 %}
	<script>
		(function () {
			const defaultLimit = {{ default_limit | default(10) }};
			const rows = Array.from(document.querySelectorAll(".comp-row"));
			if (!rows.length) return;

			const btn = document.getElementById("toggle-rows-btn");
			const filterTopped = document.getElementById("filter-topped");
			const filterFlashed = document.getElementById("filter-flashed");

			let showingAll = false;

			function rowMatchesFilter(row) {
				const isTopped = row.dataset.topped === "1";
				const isFlash = row.dataset.flash === "1";

				if (filterFlashed && filterFlashed.checked) {
					// Only flashes: must be flash
					return isFlash;
				}
				if (filterTopped && filterTopped.checked) {
					// Only topped (including flashes)
					return isTopped;
				}
				// No filters: everyone
				return true;
			}

			function applyState() {
				let visibleCount = 0;

				rows.forEach((row, idx) => {
					if (!rowMatchesFilter(row)) {
						row.style.display = "none";
						return;
					}

					if (!showingAll && visibleCount >= defaultLimit) {
						row.style.display = "none";
						return;
					}

					row.style.display = "";
					visibleCount++;
				});

				if (btn) {
					if (showingAll) {
						btn.textContent = "Show top " + defaultLimit;
					} else {
						btn.textContent = "Show all (" + rows.length + ")";
					}
				}
			}

			if (btn) {
				btn.addEventListener("click", () => {
					showingAll = !showingAll;
					applyState();
				});
			}

			if (filterTopped) {
				filterTopped.addEventListener("change", () => {
					// If flashes is on and topped is turned off, keep flashes behaviour
					applyState();
				});
			}

			if (filterFlashed) {
				filterFlashed.addEventListener("change", () => {
					// If "Only flashes" is on, it overrides "Only topped"
					if (filterFlashed.checked && filterTopped) {
						filterTopped.checked = false;
					}
					applyState();
				});
			}

			// Initial state
			applyState();
		})();
	</script>
	{% endif %}
</body>
</html>
