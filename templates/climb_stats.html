<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Climb {{ climb_number }} ¬∑ Stats</title>
	<link rel="stylesheet" href="/static/app.css" />
</head>
<body>
	<nav class="container top-nav">
		<div class="brand">
			<span class="brand-mark">üßó‚Äç‚ôÇÔ∏è</span>
			<span class="brand-name">Urban Climb Comp</span>
		</div>
		<div class="nav-links">
			<a class="back" href="/">Home</a>
			<a class="back" href="/leaderboard">Leaderboard</a>
			<!-- New: back to previous page (usually Stats) -->
			<a class="back" href="javascript:history.back()">Stats</a>
		</div>
	</nav>

	<main class="container">

		<header class="header" style="margin-bottom: 16px;">
			<h1 style="margin:0 0 4px 0; font-size:1.9rem;">
				Climb #{{ climb_number }} Stats
			</h1>
		</header>

		{% if not has_config %}
			<section class="stats-card">
				<p style="margin:0;">
					This climb is not configured in any section.
				</p>
			</section>
		{% else %}

			<section class="stats-card">
				<h2 class="stats-title">Overview</h2>

				<p style="margin: 0 0 6px 0; font-size:0.95rem; color:var(--muted);">
					Sections:
					{% if sections %}
						{% for s in sections %}
							<span>{{ s.name }}</span>{% if not loop.last %}, {% endif %}
						{% endfor %}
					{% else %}
						Unknown
					{% endif %}
				</p>

				<table class="stats-table">
					<tbody>
						<tr>
							<th>Total competitors who logged this climb</th>
							<td>{{ num_competitors }}</td>
						</tr>
						<tr>
							<th>Total attempts</th>
							<td>{{ total_attempts }}</td>
						</tr>
						<tr>
							<th>Tops</th>
							<td>{{ tops }}</td>
						</tr>
						<tr>
							<th>Flashes (topped on first attempt)</th>
							<td>{{ flashes }}</td>
						</tr>
						<tr>
							<th>Top rate</th>
							<td>
								{% if num_competitors %}
									{{ (top_rate * 100) | round(1) }}%
								{% else %}
									‚Äì
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Flash rate</th>
							<td>
								{% if num_competitors %}
									{{ (flash_rate * 100) | round(1) }}%
								{% else %}
									‚Äì
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Avg attempts per competitor</th>
							<td>
								{% if num_competitors %}
									{{ avg_attempts_per_comp | round(2) }}
								{% else %}
									‚Äì
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Avg attempts on topped climbs</th>
							<td>
								{% if tops %}
									{{ avg_attempts_on_tops | round(2) }}
								{% else %}
									‚Äì
								{% endif %}
							</td>
						</tr>
					</tbody>
				</table>
			</section>

			<section class="stats-card">
				<h2 class="stats-title">Per-Competitor Breakdown</h2>

				{% if per_competitor %}

					{% set total_rows = per_competitor|length %}
					{% set default_limit = 2 %}

					<div
						id="per-comp-controls"
						style="display:flex; justify-content:space-between; align-items:center; margin:8px 0 10px;"
					>
						<p style="margin:0; font-size:0.85rem; color:var(--muted);">
							Competitors logged: {{ total_rows }}
						</p>

						{% if total_rows > default_limit %}
							<button
								id="toggle-rows-btn"
								type="button"
								class="primary"
								style="padding:6px 10px; font-size:0.85rem;"
							>
								Show all ({{ total_rows }})
							</button>
						{% endif %}
					</div>

					<div style="max-height:70vh; overflow:auto; border-radius:10px;">
						<table class="stats-table">
							<thead>
								<tr>
									<th>Competitor</th>
									<th>Attempts</th>
									<th>Status</th>
									<th>Points</th>
								</tr>
							</thead>
							<tbody id="per-comp-body">
								{% for row in per_competitor %}
									<tr class="comp-row">
										<td>
											{{ row.name }} ( #{{ row.competitor_id }} )
										</td>
										<td>{{ row.attempts }}</td>
										<td>
											{% if row.topped %}
												{% if row.attempts == 1 %}
													Flashed
												{% else %}
													Topped
												{% endif %}
											{% else %}
												Not topped
											{% endif %}
										</td>
										<td>{{ row.points }}</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>

				{% else %}
					<p style="margin:0; color:var(--muted);">
						No competitors have logged attempts on this climb yet.
					</p>
				{% endif %}
			</section>

		{% endif %}

	</main>

	{% if per_competitor and per_competitor|length > 2 %}
	<script>
		(function () {
			const defaultLimit = 2;
			const rows = Array.from(document.querySelectorAll(".comp-row"));
			const btn = document.getElementById("toggle-rows-btn");
			if (!rows.length || !btn) return;

			let showingAll = false;

			function applyLimit() {
				if (!showingAll) {
					rows.forEach((row, idx) => {
						row.style.display = idx < defaultLimit ? "" : "none";
					});
					btn.textContent = "Show all (" + rows.length + ")";
				} else {
					rows.forEach((row) => {
						row.style.display = "";
					});
					btn.textContent = "Show top " + defaultLimit;
				}
			}

			btn.addEventListener("click", () => {
				showingAll = !showingAll;
				applyLimit();
			});

			// Initial state: top N only
			applyLimit();
		})();
	</script>
	{% endif %}
</body>
</html>