<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>
		{% if competitor %}
			{{ competitor.name }} · Climb {{ climb_number }} Stats
		{% else %}
			Climb {{ climb_number }} · Stats
		{% endif %}
	</title>
	<link rel="stylesheet" href="/static/app.css" />
</head>
<body>
	<nav class="container top-nav">
		<div class="nav-links">
			{% if competitor %}
				<a class="back" href="/leaderboard?cid={{ competitor.id }}">Leaderboard</a>
				<a class="back" href="/competitor/{{ competitor.id }}/sections">Sections</a>
				<a class="back" href="/competitor/{{ competitor.id }}/stats">Stats</a>
			{% else %}
				<a class="back" href="/leaderboard">Leaderboard</a>
			{% endif %}
		</div>
	</nav>

	<main class="container">

		{% if competitor %}
			<!-- Unified header: same as other competitor pages -->
			<header class="comp-header">
				<h1 class="comp-name">
					<span class="comp-label">Name:</span>
					<span class="comp-value">{{ competitor.name }}</span>
				</h1>

				<div class="comp-meta-row">
					<div class="comp-pill">
						<span class="comp-pill-label">Competitor #</span>
						<span class="comp-pill-value">{{ competitor.id }}</span>
					</div>

					{% if total_points is not none %}
						<div class="comp-pill">
							<span class="comp-pill-label">Points</span>
							<span class="comp-pill-value">{{ total_points }}</span>
						</div>
					{% endif %}

					{% if position is not none %}
						<div class="comp-pill">
							<span class="comp-pill-label">Position</span>
							<span class="comp-pill-value">{{ position }}</span>
						</div>
					{% endif %}
				</div>
			</header>

			<h2 class="stats-title" style="margin-top: 0;">
				Climb #{{ climb_number }} Stats
			</h2>
		{% else %}
			<header class="header" style="margin-bottom: 16px;">
				<h1 style="margin:0 0 4px 0; font-size:1.9rem;">
					Climb #{{ climb_number }} Stats
				</h1>
			</header>
		{% endif %}

		{% if not has_config %}
			<section class="stats-card">
				<p style="margin:0;">
					This climb is not configured in any section.
				</p>
			</section>
		{% else %}

			<!-- OVERVIEW CARD -->
			<section class="stats-card">
				<h2 class="stats-title">Overview</h2>

				<p style="margin: 0 0 6px 0; font-size:0.95rem; color:var(--muted);">
					Section:
					{% if sections %}
						{% for s in sections %}
							<span>{{ s.name }}</span>{% if not loop.last %}, {% endif %}
						{% endfor %}
					{% else %}
						Unknown
					{% endif %}
				</p>

				<table class="stats-table overview-table">
					<tbody>
						<tr>
							<th>Total competitors who logged this climb</th>
							<td>{{ num_competitors }}</td>
						</tr>
						<tr>
							<th>Total attempts</th>
							<td>{{ total_attempts }}</td>
						</tr>
						<tr>
							<th>Tops</th>
							<td>{{ tops }}</td>
						</tr>
						<tr>
							<th>Flashes (topped on first attempt)</th>
							<td>{{ flashes }}</td>
						</tr>
						<tr>
							<th>Top rate</th>
							<td>
								{% if num_competitors %}
									{{ (top_rate * 100) | round(1) }}%
								{% else %}
									–
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Flash rate</th>
							<td>
								{% if num_competitors %}
									{{ (flash_rate * 100) | round(1) }}%
								{% else %}
									–
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Avg attempts per competitor</th>
							<td>
								{% if num_competitors %}
									{{ avg_attempts_per_comp | round(2) }}
								{% else %}
									–
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Avg attempts on topped climbs</th>
							<td>
								{% if tops %}
									{{ avg_attempts_on_tops | round(2) }}
								{% else %}
									–
								{% endif %}
							</td>
						</tr>
					</tbody>
				</table>
			</section>

			<!-- PER-COMPETITOR CARD -->
			<section class="stats-card">
				<h2 class="stats-title">Per-Competitor Breakdown</h2>

				{% if per_competitor %}
					{% set total_rows = per_competitor|length %}
					{% set default_limit = 2 %}

					<div
						id="per-comp-controls"
						style="
							display:flex;
							flex-wrap:wrap;
							gap:8px 16px;
							justify-content:space-between;
							align-items:center;
							margin:8px 0 10px;
						"
					>
						<p style="margin:0; font-size:0.85rem; color:var(--muted);">
							Competitors logged: {{ total_rows }}
							{% if total_rows > default_limit %}
								· Showing top {{ default_limit }} by default
							{% endif %}
						</p>

						<div style="display:flex; flex-wrap:wrap; gap:8px 12px; align-items:center;">
							<label style="display:inline-flex; align-items:center; gap:6px; font-size:0.85rem;">
								<input type="checkbox" id="filter-topped" />
								<span>Only topped</span>
							</label>

							<label style="display:inline-flex; align-items:center; gap:6px; font-size:0.85rem;">
								<input type="checkbox" id="filter-flashed" />
								<span>Only flashes</span>
							</label>

							{% if total_rows > default_limit %}
								<button
									id="toggle-rows-btn"
									type="button"
									class="primary"
									style="padding:6px 10px; font-size:0.85rem;"
								>
									Show all ({{ total_rows }})
								</button>
							{% endif %}
						</div>
					</div>

					<div style="max-height:70vh; overflow-y:auto; border-radius:10px;">
						<div class="stats-table-wrapper per-competitor-wrapper">
							<table class="stats-table per-competitor-table">
								<thead>
									<tr>
										<th>Competitor</th>
										<th>Attempts</th>
										<th>Status</th>
									</tr>
								</thead>
								<tbody id="per-comp-body">
									{% for row in per_competitor %}
										<tr
											class="comp-row"
											data-topped="{{ 1 if row.topped else 0 }}"
											data-flash="{{ 1 if row.topped and row.attempts == 1 else 0 }}"
										>
											<td>
												{{ row.name }} ( #{{ row.competitor_id }} )
											</td>
											<td>{{ row.attempts }}</td>
											<td>
												{% if row.topped %}
													{% if row.attempts == 1 %}
														Flashed
													{% else %}
														Topped
													{% endif %}
												{% else %}
													Not topped
												{% endif %}
											</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>

				{% else %}
					<p style="margin:0; color:var(--muted);">
						No competitors have logged attempts on this climb yet.
					</p>
				{% endif %}
			</section>

		{% endif %}

	</main>

	{% if per_competitor and per_competitor|length > 0 %}
	<script>
		(function () {
			const defaultLimit = {{ default_limit | default(25) }};
			const rows = Array.from(document.querySelectorAll(".comp-row"));
			if (!rows.length) return;

			const btn = document.getElementById("toggle-rows-btn");
			const filterTopped = document.getElementById("filter-topped");
			const filterFlashed = document.getElementById("filter-flashed");

			let showingAll = false;

			function rowMatchesFilter(row) {
				const isTopped = row.dataset.topped === "1";
				const isFlash = row.dataset.flash === "1";

				if (filterFlashed && filterFlashed.checked) {
					return isFlash;
				}
				if (filterTopped && filterTopped.checked) {
					return isTopped;
				}
				return true;
			}

			function applyState() {
				let visibleCount = 0;

				rows.forEach((row) => {
					if (!rowMatchesFilter(row)) {
						row.style.display = "none";
						return;
					}

					if (!showingAll && visibleCount >= defaultLimit) {
						row.style.display = "none";
						return;
					}

					row.style.display = "";
					visibleCount++;
				});

				if (btn) {
					if (showingAll) {
						btn.textContent = "Show top " + defaultLimit;
					} else {
						btn.textContent = "Show all (" + rows.length + ")";
					}
				}
			}

			if (btn) {
				btn.addEventListener("click", () => {
					showingAll = !showingAll;
					applyState();
				});
			}

			if (filterTopped) {
				filterTopped.addEventListener("change", () => {
					applyState();
				});
			}

			if (filterFlashed) {
				filterFlashed.addEventListener("change", () => {
					if (filterFlashed.checked && filterTopped) {
						filterTopped.checked = false;
					}
					applyState();
				});
			}

			applyState();
		})();
	</script>
	{% endif %}
</body>
</html>
