<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>
		{% if competitor %}
			{{ competitor.name }} · Climb {{ climb_number }} Stats
		{% else %}
			Climb {{ climb_number }} · Stats
		{% endif %}
	</title>
	<link rel="stylesheet" href="/static/app.css" />
</head>
<body>
	{% set viewer_id = session.get('competitor_id') %}
	<nav class="container top-nav">
		<div class="nav-links">
			<a
				class="back {% if nav_active == 'leaderboard' %}active{% endif %}"
				href="/leaderboard{% if viewer_id %}?cid={{ viewer_id }}{% endif %}"
			>
				Leaderboard
			</a>
			{% if viewer_id %}
				<a
					class="back {% if nav_active == 'sections' %}active{% endif %}"
					href="/competitor/{{ viewer_id }}/sections"
				>
					Sections
				</a>
				<a
					class="back {% if nav_active == 'stats' %}active{% endif %}"
					href="/competitor/{{ viewer_id }}/stats"
				>
					Stats
				</a>
			{% endif %}
		</div>
	</nav>

	<main class="container">

		{% if competitor %}
			<header class="comp-header">
				<h1 class="comp-name">
					<span class="comp-label">Name:</span>
					<span class="comp-value">{{ competitor.name }}</span>
				</h1>

				<div class="comp-meta-row">
					<div class="comp-pill">
						<span class="comp-pill-label">Competitor</span>
						<span class="comp-pill-value">{{ competitor.id }}</span>
					</div>

					{% if total_points is not none %}
						<div class="comp-pill">
							<span class="comp-pill-label">Points</span>
							<span class="comp-pill-value">{{ total_points }}</span>
						</div>
					{% endif %}

					{% if position is not none %}
						<div class="comp-pill">
							<span class="comp-pill-label">Position</span>
							<span class="comp-pill-value">{{ position }}</span>
						</div>
					{% endif %}
				</div>
			</header>

			<h2 class="stats-title" style="margin-top: 0;">
				Climb #{{ climb_number }} Stats
			</h2>
		{% else %}
			<header class="header" style="margin-bottom: 16px;">
				<h1 style="margin:0 0 4px 0; font-size:1.9rem;">
					Climb #{{ climb_number }} Stats
				</h1>
			</header>
		{% endif %}

		{% if not has_config %}
			<section class="stats-card">
				<p style="margin:0;">
					This climb is not configured in any section.
				</p>
			</section>
		{% else %}

			<!-- OVERVIEW -->
			<section class="stats-card">
				<h2 class="stats-title">Overview</h2>

				{# --- Show this specific competitor's result (visible to everyone) --- #}
				{% if competitor %}
					{% if personal_row %}
						<p style="margin: 0 0 8px 0; font-size:0.95rem; color:var(--text);">
							<strong>{{ competitor.name }}:</strong>

							{% if personal_row.topped %}
								{% if personal_row.attempts == 1 %}
									<span
										class="status-flashed"
										style="
											display:inline-block;
											margin-left:8px;
											padding:2px 10px;
											border-radius:999px;
											font-size:0.8rem;
											color:#fff;
										"
									>
										Flashed
									</span>
								{% else %}
									<span
										class="status-topped-late"
										style="
											display:inline-block;
											margin-left:8px;
											padding:2px 10px;
											border-radius:999px;
											font-size:0.8rem;
											color:#fff;
										"
									>
										Topped
									</span>
								{% endif %}
							{% else %}
								<span
									class="status-not-topped"
									style="
										display:inline-block;
										margin-left:8px;
										padding:2px 10px;
										border-radius:999px;
										font-size:0.8rem;
										color:#000;
									"
								>
									Not topped
								</span>
							{% endif %}

							<span style="margin-left:8px;">
								{{ personal_row.attempts }} attempt{% if personal_row.attempts != 1 %}s{% endif %}
							</span>
						</p>
					{% else %}
						<p style="margin: 0 0 8px 0; font-size:0.95rem; color:var(--muted);">
							<strong>{{ competitor.name }} has not logged this climb yet.</strong>
						</p>
					{% endif %}
				{% endif %}

				<p style="margin: 8px 0 6px 0; font-size:0.95rem; color:var(--muted);">
					Section:
					{% if sections %}
						{% for s in sections %}
							<span>{{ s.name }}</span>{% if not loop.last %}, {% endif %}
						{% endfor %}
					{% else %}
						Unknown
					{% endif %}
				</p>

				<table class="stats-table overview-table">
					<tbody>
						<tr><th>Total competitors who logged this climb</th><td>{{ num_competitors }}</td></tr>
						<tr><th>Total attempts</th><td>{{ total_attempts }}</td></tr>
						<tr><th>Tops</th><td>{{ tops }}</td></tr>
						<tr><th>Flashes (topped on first attempt)</th><td>{{ flashes }}</td></tr>
						<tr>
							<th>Top rate</th>
							<td>
								{% if num_competitors %}
									{{ (top_rate * 100) | round(1) }}%
								{% else %}
									–
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Flash rate</th>
							<td>
								{% if num_competitors %}
									{{ (flash_rate * 100) | round(1) }}%
								{% else %}
									–
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Avg attempts per competitor</th>
							<td>
								{% if num_competitors %}
									{{ avg_attempts_per_comp | round(2) }}
								{% else %}
									–
								{% endif %}
							</td>
						</tr>
						<tr>
							<th>Avg attempts per competitor who topped</th>
							<td>
								{% if tops %}
									{{ avg_attempts_on_tops | round(2) }}
								{% else %}
									–
								{% endif %}
							</td>
						</tr>
					</tbody>
				</table>
			</section>

			<!-- PER-COMPETITOR -->
			<section class="stats-card">
				<h2 class="stats-title">Per-Competitor Breakdown</h2>

				{% if per_competitor %}
					{% set total_rows = per_competitor|length %}
					{% set default_limit = 2 %}

					<div
						id="per-comp-controls"
						style="
							display:flex;
							flex-direction:column;
							align-items:flex-start;
							gap:8px;
							margin:8px 0 10px;
						"
					>
						<p style="margin:0; font-size:0.85rem; color:var(--muted);">
							Competitors logged: {{ total_rows }}
							{% if total_rows > default_limit %}
								· Showing top {{ default_limit }} by default
							{% endif %}
						</p>

						<div style="display:flex; flex-wrap:wrap; gap:8px;">
							<button id="btn-topped" class="filter-btn" type="button">
								Only Topped
							</button>
							<button id="btn-flashed" class="filter-btn" type="button">
								Only Flashes
							</button>

							{% if total_rows > default_limit %}
								<button
									id="toggle-rows-btn"
									type="button"
									class="primary"
									style="padding:6px 10px; font-size:0.85rem;"
								>
									Show all ({{ total_rows }})
								</button>
							{% endif %}
						</div>
					</div>

					<div style="max-height:70vh; overflow-y:auto; border-radius:10px;">
						<div class="stats-table-wrapper per-competitor-wrapper" style="overflow-x:auto;">
							<table
								class="stats-table per-competitor-table"
								style="width:auto; min-width:0; font-size:0.9rem;"
							>
								<thead>
									<tr>
										<th style="white-space:nowrap;">Competitor</th>
										<th style="white-space:nowrap;">Attempts</th>
										<th style="white-space:nowrap;">Status</th>
									</tr>
								</thead>
								<tbody id="per-comp-body">
									{% for row in per_competitor %}
										<tr
											class="comp-row"
											data-topped="{{ 1 if row.topped else 0 }}"
											data-flash="{{ 1 if row.topped and row.attempts == 1 else 0 }}"
										>
											<td style="white-space:nowrap;">
												{{ row.name }} (#{{ row.competitor_id }})
											</td>
											<td>{{ row.attempts }}</td>
											<td>
												{% if row.topped %}
													{% if row.attempts == 1 %}
														Flashed
													{% else %}
														Topped
													{% endif %}
												{% else %}
													Not topped
												{% endif %}
											</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>

				{% else %}
					<p style="margin:0; color:var(--muted);">
						No competitors have logged attempts on this climb yet.
					</p>
				{% endif %}
			</section>

		{% endif %}

	</main>

	{% if per_competitor and per_competitor|length > 0 %}
	<script>
		(function () {
			const defaultLimit = {{ default_limit | default(25) }};
			const rows = Array.from(document.querySelectorAll(".comp-row"));
			if (!rows.length) return;

			const btnShowAll = document.getElementById("toggle-rows-btn");
			const btnTopped = document.getElementById("btn-topped");
			const btnFlashed = document.getElementById("btn-flashed");

			let showingAll = false;
			let filterMode = "none"; // "topped", "flashed", "none"

			function rowMatchesFilter(row) {
				const isTopped = row.dataset.topped === "1";
				const isFlash = row.dataset.flash === "1";

				if (filterMode === "flashed") return isFlash;
				if (filterMode === "topped") return isTopped;
				return true;
			}

			function applyState() {
				let visibleCount = 0;

				rows.forEach((row) => {
					if (!rowMatchesFilter(row)) {
						row.style.display = "none";
						return;
					}

					if (!showingAll && visibleCount >= defaultLimit) {
						row.style.display = "none";
						return;
					}

					row.style.display = "";
					visibleCount++;
				});

				if (btnShowAll) {
					btnShowAll.textContent = showingAll
						? "Show top " + defaultLimit
						: "Show all (" + rows.length + ")";
				}
			}

			// Filter buttons
			if (btnTopped) {
				btnTopped.addEventListener("click", () => {
					if (filterMode === "topped") {
						filterMode = "none";
					} else {
						filterMode = "topped";
					}

					btnTopped.classList.toggle("active", filterMode === "topped");
					if (btnFlashed) btnFlashed.classList.remove("active");

					// When filtering, show all by default
					showingAll = true;
					applyState();
				});
			}

			if (btnFlashed) {
				btnFlashed.addEventListener("click", () => {
					if (filterMode === "flashed") {
						filterMode = "none";
					} else {
						filterMode = "flashed";
					}

					btnFlashed.classList.toggle("active", filterMode === "flashed");
					if (btnTopped) btnTopped.classList.remove("active");

					showingAll = true;
					applyState();
				});
			}

			// Show all / show top toggle
			if (btnShowAll) {
				btnShowAll.addEventListener("click", () => {
					showingAll = !showingAll;
					applyState();
				});
			}

			applyState();
		})();
	</script>
	{% endif %}
</body>
</html>