<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Competitor {{ competitor.id }} ¬∑ Urban Climb Comp</title>
		<link rel="stylesheet" href="/static/app.css" />
	</head>
	<body>
		<nav class="container top-nav">
			<div class="brand">
				<span class="brand-mark">üßó‚Äç‚ôÇÔ∏è</span>
				<span class="brand-name">Urban Climb Comp</span>
			</div>
			<div class="nav-links">
				<a class="back" href="/">Home</a>
				<a class="back" href="/leaderboard">Leaderboard</a>
			</div>
		</nav>

		<main class="container">
			<header class="header">
				<div>
					<h1>Name: {{ competitor.name }}</h1>
					<p>Competitor #{{ competitor.id }}</p>
				</div>
				<div class="points-header">
					Points: <span id="total-points">{{ total_points }}</span>
				</div>
			</header>

			<section class="card" style="margin-bottom:16px;">
				<header class="section-header">
					<h2 class="section-title">
						{% if section %}
							{{ section.name }}
						{% else %}
							Climbs
						{% endif %}
					</h2>
				</header>
			
				<section class="grid">
					{% for n in climbs %}
						{% set s = existing.get(n) %}
						{% set max_pts = max_points.get(n) if max_points is defined else None %}
						<div class="climb-card" data-climb="{{ n }}">
							<h3>Climb #{{ n }}</h3>

							{# Optional colour line if a 'colours' dict is passed in the context #}
							{% if colours is defined %}
								{% set col = colours.get(n) %}
								{% if col %}
									<p class="climb-colour">{{ col }}</p>
								{% endif %}
							{% endif %}

							{# NEW: show max points if available #}
							{% if max_pts is not none %}
								<p style="margin: 4px 0 0;">
									Max points: {{ max_pts }}
								</p>
							{% endif %}

							<div class="row">
								<label>Attempts</label>
								<input
									type="number"
									min="1"
									max="50"
									value="{{ s.attempts if s else 1 }}"
									class="attempts"
								/>
							</div>

							<div class="row">
								<label class="check">
									<input
										type="checkbox"
										class="topped"
										{% if s and s.topped %}checked{% endif %}
									/>
									<span>Topped</span>
								</label>
							</div>

							<button class="save">Save</button>
							<div class="status" aria-live="polite"></div>
						</div>
					{% endfor %}
				</section>
			</section>

			<section class="summary card">
				<h3>Summary</h3>
				<ul id="summary-list"></ul>
			</section>
		</main>

		<script>
			const competitorId = {{ competitor.id }};
			const cards = document.querySelectorAll(".climb-card");

			function showStatus(el, msg, ok = true) {
				el.textContent = msg;
				el.className = "status " + (ok ? "ok" : "err");
				setTimeout(() => {
					el.textContent = "";
					el.className = "status";
				}, 1500);
			}

			async function save(card) {
				const climb = parseInt(card.dataset.climb);
				let attempts = parseInt(card.querySelector(".attempts").value || "1");
				const topped = card.querySelector(".topped").checked;
				const status = card.querySelector(".status");

				if (isNaN(attempts) || attempts < 1) {
					attempts = 1;
					card.querySelector(".attempts").value = 1;
				}
				if (attempts > 50) {
					attempts = 50;
					card.querySelector(".attempts").value = 50;
				}

				try {
					const res = await fetch("/api/score", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							competitor_id: competitorId,
							climb_number: climb,
							attempts,
							topped,
						}),
					});

					if (!res.ok) {
						const t = await res.text();
						showStatus(status, "Error: " + t, false);
						return;
					}

					await res.json();
					showStatus(status, "Saved");
					refreshSummary();
				} catch (e) {
					showStatus(status, "Network error", false);
				}
			}

			async function refreshSummary() {
				try {
					const res = await fetch(`/api/score/${competitorId}`);
					const rows = await res.json();
					const ul = document.getElementById("summary-list");
					const totalEl = document.getElementById("total-points");

					ul.innerHTML = "";
					let totalPoints = 0;

					rows.forEach((r) => {
						totalPoints += r.points || 0;
						const li = document.createElement("li");
						li.textContent = `Climb #${r.climb_number}: attempts ${r.attempts}, ${
							r.topped ? "TOP" : "no top"
						} (${r.points} pts)`;
						ul.appendChild(li);
					});

					if (totalEl) {
						totalEl.textContent = totalPoints;
					}
				} catch (e) {
					/* silent */
				}
			}

			cards.forEach((card) => {
				card.querySelector(".save").addEventListener("click", () => save(card));
			});

			refreshSummary();
		</script>
	</body>
</html>