<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Competitor {{ competitor.id }} Â· Urban Climb Comp</title>
		<link rel="stylesheet" href="/static/app.css" />
	</head>
	<body>
		<nav class="container top-nav">
			<div class="nav-links">
				<a class="back" href="/leaderboard?cid={{ competitor.id }}">Leaderboard</a>
				<a class="back" href="/competitor/{{ competitor.id }}/sections">Sections</a>
				<a class="back" href="/competitor/{{ competitor.id }}/stats">Stats</a>
			</div>
		</nav>

		<main class="container">

			<!-- Unified header: big name + pills -->
			<header class="comp-header">
				<h1 class="comp-name">
					<span class="comp-label">Name:</span>
					<span class="comp-value">{{ competitor.name }}</span>
				</h1>

				<div class="comp-meta-row">
					<div class="comp-pill">
						<span class="comp-pill-label">Competitor #</span>
						<span class="comp-pill-value">{{ competitor.id }}</span>
					</div>

					<div class="comp-pill">
						<span class="comp-pill-label">Points</span>
						<span class="comp-pill-value" id="total-points">{{ total_points }}</span>
					</div>

					{% if position is defined and position is not none %}
						<div class="comp-pill">
							<span class="comp-pill-label">Position</span>
							<span class="comp-pill-value" id="position-value">
								{{ position }}
							</span>
						</div>
					{% endif %}
				</div>
			</header>

			<section class="card" style="margin-bottom:16px;">
				<header class="section-header">
					<h2 class="section-title">
						{% if section %}
							{{ section.name }}
						{% else %}
							Climbs
						{% endif %}
					</h2>
				</header>
			
				<section class="grid">
					{% for n in climbs %}
						{% set s = existing.get(n) %}
						{% set max_pts = max_points.get(n) if max_points is defined else None %}
						<div class="climb-card" data-climb="{{ n }}">
							<h3>Climb #{{ n }}</h3>

							{% if colours is defined %}
								{% set col = colours.get(n) %}
								{% if col %}
									<p class="climb-colour">{{ col }}</p>
								{% endif %}
							{% endif %}

							{% if max_pts is not none %}
								<p style="margin: 4px 0 0;">
									Max points: {{ max_pts }}
								</p>
							{% endif %}

							<div class="row">
								<label>Attempts</label>
								<input
									type="number"
									min="1"
									max="50"
									value="{{ s.attempts if s else 1 }}"
									class="attempts"
								/>
							</div>

							<div class="row">
								<label class="check">
									<input
										type="checkbox"
										class="topped"
										{% if s and s.topped %}checked{% endif %}
									/>
									<span>Topped</span>
								</label>
							</div>

							<button class="save">Save</button>
							<div class="status" aria-live="polite"></div>
						</div>
					{% endfor %}
				</section>
			</section>

		</main>

		<script>
			const competitorId = {{ competitor.id }};
			const cards = document.querySelectorAll(".climb-card");

			function showStatus(el, msg, ok = true) {
				el.textContent = msg;
				el.className = "status " + (ok ? "ok" : "err");
				setTimeout(() => {
					el.textContent = "";
					el.className = "status";
				}, 1500);
			}

			async function save(card) {
				const climb = parseInt(card.dataset.climb);
				let attempts = parseInt(card.querySelector(".attempts").value || "1");
				const topped = card.querySelector(".topped").checked;
				const status = card.querySelector(".status");

				if (isNaN(attempts) || attempts < 1) {
					attempts = 1;
					card.querySelector(".attempts").value = 1;
				}
				if (attempts > 50) {
					attempts = 50;
					card.querySelector(".attempts").value = 50;
				}

				try {
					const res = await fetch("/api/score", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							competitor_id: competitorId,
							climb_number: climb,
							attempts,
							topped,
						}),
					});

					if (!res.ok) {
						const t = await res.text();
						showStatus(status, "Error: " + t, false);
						return;
					}

					await res.json();
					showStatus(status, "Saved");

					// Update total points + position after save
					await refreshTotalPoints();
					refreshPosition();
				} catch (e) {
					showStatus(status, "Network error", false);
				}
			}

			// Recompute total points only
			async function refreshTotalPoints() {
				try {
					const res = await fetch(`/api/score/${competitorId}`);
					const rows = await res.json();
					const totalEl = document.getElementById("total-points");
					if (!totalEl) return;

					let totalPoints = 0;
					rows.forEach((r) => {
						totalPoints += r.points || 0;
					});

					totalEl.textContent = totalPoints;
				} catch (e) {
					/* silent */
				}
			}

			async function refreshPosition() {
				try {
					const res = await fetch("/api/leaderboard");
					const data = await res.json();

					if (!data.rows) return;

					const posValue = document.getElementById("position-value");
					if (!posValue) return;

					for (const row of data.rows) {
						if (row.competitor_id === competitorId) {
							posValue.textContent = row.position;
							break;
						}
					}
				} catch (e) {
					/* silent */
				}
			}

			cards.forEach((card) => {
				card.querySelector(".save").addEventListener("click", async () => {
					await save(card);
				});
			});

			// Initial load
			refreshTotalPoints();
			refreshPosition();
		</script>
	</body>
</html>

