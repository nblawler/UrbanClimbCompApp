<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Competitor {{ competitor.id }} · Urban Climb Comp</title>
		<link rel="stylesheet" href="/static/app.css" />

		<style>
			/* ------------------------------------------------------------
			   FIX: Make scoring page map sizing match sections page map sizing
			   ------------------------------------------------------------ */

			/* Ensure the map container is the positioning reference */
			.map-wrapper {
				position: relative;
				width: 100%;
				border-radius: 1rem;
				overflow: hidden;
				border: 1px solid rgba(255, 255, 255, 0.1);
				background: #000;
			}

			/* Force the map image to scale only by width (no stretching/cropping) */
			.map-wrapper img.gym-map {
				display: block;
				width: 100%;
				height: auto;
				max-width: 100%;
				/* override any global img rules */
				object-fit: initial !important;
			}

			/* Make sure dots position relative to the wrapper */
			.map-dot {
				position: absolute;
				transform: translate(-50%, -50%);
			}

			/* (Optional) if app.css gives buttons weird line-height/padding */
			.map-dot.map-dot-interactive {
				padding: 0;
				line-height: 1;
			}
		</style>
	</head>
	<body>
		{% set viewer_id = viewer_id if viewer_id is defined else session.get('competitor_id') %}
		{% set is_admin = session.get('admin_ok', False) %}
		{% set comp_slug = comp_slug if comp_slug is defined else session.get('active_comp_slug') %}

		<nav class="container top-nav">
			<div class="nav-links">
				<a class="back {% if nav_active == 'my_comps' %}active{% endif %}" href="/my-comps">Home</a>

				{% if is_admin %}
					<a class="back {% if nav_active == 'admin' %}active{% endif %}" href="/admin/comps">Admin</a>
				{% endif %}

				{% if viewer_id or is_admin %}
					<a class="back" href="/logout">Log out</a>
				{% else %}
					<a class="back {% if nav_active == 'login' %}active{% endif %}"
					   href="/login{% if comp_slug %}?slug={{ comp_slug }}{% endif %}">
						Log in
					</a>
				{% endif %}

				{% if viewer_id %}
					{% if comp_slug %}
						<a class="back {% if nav_active == 'sections' %}active{% endif %}"
						   href="/comp/{{ comp_slug }}/competitor/{{ viewer_id }}/sections">
							Climb Map
						</a>
					{% else %}
						<a class="back {% if nav_active == 'sections' %}active{% endif %}"
						   href="/competitor/{{ viewer_id }}/sections">
							Climb Map
						</a>
					{% endif %}

					<a class="back {% if nav_active == 'my_stats' %}active{% endif %}"
					   href="/competitor/{{ viewer_id }}/stats/my">
						My Stats
					</a>

					<a class="back {% if nav_active == 'overall_stats' %}active{% endif %}"
					   href="/competitor/{{ viewer_id }}/stats/overall">
						Overall Stats
					</a>
				{% endif %}

				<a class="back {% if nav_active == 'leaderboard' %}active{% endif %}"
				   href="/leaderboard{% if viewer_id %}?cid={{ viewer_id }}{% endif %}">
					Leaderboard
				</a>
			</div>
		</nav>

		<main class="container">

			<header class="comp-header">
				<h1 class="comp-name">
					<span class="comp-label">Name:</span>
  					<span class="comp-value">{{ competitor.name }}</span>
				</h1>

				<div class="comp-meta-row">
					<div class="comp-pill">
						<span class="comp-pill-label">Competitor</span>
						<span class="comp-pill-value">{{ competitor.id }}</span>
					</div>

					<div class="comp-pill">
						<span class="comp-pill-label">Points</span>
						<span class="comp-pill-value" id="total-points">{{ total_points }}</span>
					</div>

					{% if position is defined and position is not none %}
						<div class="comp-pill">
							<span class="comp-pill-label">Position</span>
							<span class="comp-pill-value" id="position-value">{{ position }}</span>
						</div>
					{% endif %}
				</div>
			</header>

			{% if sections is defined and sections %}
			<div class="section-filter-row section-filter-row--with-button">
				<div class="section-filter-left">
					<div class="section-filter-label">Sections:</div>
					<div class="section-filter-pills">
						{% for sec in sections %}
							<a
								href="/competitor/{{ competitor.id }}/section/{{ sec.slug }}"
								class="section-filter-pill {% if section is defined and section and section.id == sec.id %}is-active{% endif %}"
							>
								{{ sec.name }}
							</a>
						{% endfor %}
					</div>
				</div>

				{% if comp_slug %}
					<a class="back-to-map-btn back-to-map-btn-inline"
					   href="/comp/{{ comp_slug }}/competitor/{{ competitor.id }}/sections">
						Back to Gym Map
					</a>
				{% else %}
					<a class="back-to-map-btn back-to-map-btn-inline"
					   href="/competitor/{{ competitor.id }}/sections">
						Back to Gym Map
					</a>
				{% endif %}
			</div>
			{% endif %}

			{% if section_climbs is defined %}
			<section class="card map-card">
				<header class="section-header">
					<h2 class="section-title">{{ section.name }}</h2>
				</header>

				<div class="map-wrapper">
					{% if gym_map_url %}
						<img class="gym-map" src="{{ gym_map_url }}" alt="Gym map" />
					{% else %}
					<div class="alert alert-error">
						No gym map found for this competition/gym.
					</div>
					{% endif %}

					{% for sc in section_climbs %}
						{% if sc.x_percent is not none and sc.y_percent is not none %}
							{% set col_raw = sc.colour %}
							{% if col_raw %}
								{% set lc = col_raw|lower %}
								{% if lc == "red" %}
									{% set bg = "#b32121" %}
								{% elif lc in ["white", "#fff", "#ffffff"] %}
									{% set bg = "#ffffff" %}
								{% else %}
									{% set bg = col_raw %}
								{% endif %}
							{% else %}
								{% set bg = "#5df29c" %}
							{% endif %}

							{% if bg|lower in ["white", "#fff", "#ffffff"] %}
								{% set text_color = "#000000" %}
							{% else %}
								{% set text_color = "#000000" %}
							{% endif %}

							<button
								type="button"
								class="map-dot map-dot-interactive"
								style="left: {{ sc.x_percent }}%; top: {{ sc.y_percent }}%; background: {{ bg }}; color: {{ text_color }};"
								data-climb="{{ sc.climb_number }}"
								title="Climb {{ sc.climb_number }}{% if sc.colour %} · {{ sc.colour }}{% endif %}"
							>
								{{ sc.climb_number }}
							</button>
						{% endif %}
					{% endfor %}
				</div>
			</section>
			{% endif %}

			<section class="card" style="margin-bottom:16px;">
				<header class="section-header">
					<h2 class="section-title">
						{% if section %} {{ section.name }} {% else %} Climbs {% endif %}
					</h2>
				</header>

				<section class="grid">
					{% for n in climbs %}
						{% set s = existing.get(n) %}
						{% set max_pts = max_points.get(n) if max_points is defined else None %}
						{% set col_raw = colours.get(n) if colours is defined else None %}

						{% if col_raw %}
							{% set lc = col_raw|lower %}
							{% if lc == "red" %}
								{% set col_bg = "#b32121" %}
							{% elif lc in ["white", "#fff", "#ffffff"] %}
								{% set col_bg = "#ffffff" %}
							{% else %}
								{% set col_bg = col_raw %}
							{% endif %}
						{% else %}
							{% set col_bg = "#e5e7eb" %}
						{% endif %}

						{% if col_bg|lower in ["white", "#fff", "#ffffff", "#e5e7eb", "#facc15", "#fef9c3"] %}
							{% set pill_text_color = "#05060a" %}
						{% else %}
							{% set pill_text_color = "#ffffff" %}
						{% endif %}

						{% set cap = 5 %}
						{% if section_climbs is defined %}
							{% for sc in section_climbs %}
								{% if sc.climb_number == n and sc.attempt_cap %}
									{% set cap = sc.attempt_cap %}
								{% endif %}
							{% endfor %}
						{% endif %}

						{% if s %}
							{% set sel_attempt = s.attempts %}
						{% else %}
							{% set sel_attempt = 1 %}
						{% endif %}
						{% if sel_attempt > cap %}
							{% set sel_attempt = cap %}
						{% endif %}

						<div class="climb-card climb-row" id="climb-{{ n }}" data-climb="{{ n }}" data-climb-row="{{ n }}" data-attempt-cap="{{ cap }}">
							<div class="climb-header">
								<span class="climb-title">Climb #{{ n }}</span>

								{% if col_raw %}
									<span class="climb-colour-pill" style="background: {{ col_bg }}; color: {{ pill_text_color }};">
										{{ col_raw }}
									</span>
								{% endif %}
							</div>

							{% if max_pts is not none %}
								<p style="margin:4px 0 0;">Max Points: {{ max_pts }}</p>
							{% endif %}

							<p style="margin:2px 0 8px; font-size:0.9rem;">
								Points Scored:
								<span class="points-scored-value">
									{% if per_climb_points is defined %}
										{{ per_climb_points.get(n, 0) }}
									{% else %}
										0
									{% endif %}
								</span>
							</p>

							<div class="climb-actions">
								<div class="climb-actions-row">
									<button type="button" class="flash-btn action-pill" {% if not can_edit %}disabled{% endif %}>Flash</button>
									<button type="button" class="topped-toggle-btn action-pill" {% if not can_edit %}disabled{% endif %}>Topped</button>
								</div>

								<div class="climb-actions-row attempts-row">
									<span class="attempts-label">Attempts</span>
									<div class="attempts-pill-row" data-selected-attempt="{{ sel_attempt }}">
										{% for i in range(1, cap + 1) %}
											<button type="button" class="attempt-pill" data-attempt="{{ i }}" {% if not can_edit %}disabled{% endif %}>{{ i }}</button>
										{% endfor %}
									</div>
								</div>

								<div class="status" aria-live="polite"></div>
							</div>
						</div>
					{% endfor %}
				</section>
			</section>

		</main>

		<script>
			const viewerId = {{ viewer_id if viewer_id is not none else 'null' }};
			const competitorIdForDisplay = {{ competitor.id }};
			const canEdit = {{ 'true' if can_edit else 'false' }};

			const cards = document.querySelectorAll(".climb-card");

			function showStatus(el, msg, ok = true) {
				if (!el) return;
				el.textContent = msg;
				el.className = "status " + (ok ? "ok" : "err");
				setTimeout(() => {
					el.textContent = "";
					el.className = "status";
				}, 1500);
			}

			function getCurrentState(card) {
				const attemptsContainer = card.querySelector(".attempts-pill-row");
				const toppedToggle = card.querySelector(".topped-toggle-btn");

				let attempts = 1;
				if (attemptsContainer) {
					const raw = attemptsContainer.dataset.selectedAttempt || "1";
					const parsed = parseInt(raw, 10);
					if (!isNaN(parsed) && parsed >= 1) attempts = parsed;
				}

				const topped = !!(toppedToggle && toppedToggle.classList.contains("is-active"));
				return { attempts, topped };
			}

			async function save(card, override) {
				if (!canEdit || viewerId === null) {
					showStatus(card.querySelector(".status"), "Not allowed", false);
					return;
				}

				const climb = parseInt(card.dataset.climb, 10);
				const status = card.querySelector(".status");

				let { attempts, topped } = getCurrentState(card);

				if (override && typeof override.attempts === "number") attempts = override.attempts;
				if (override && typeof override.topped === "boolean") topped = override.topped;

				if (isNaN(attempts) || attempts < 1) attempts = 1;
				if (attempts > 50) attempts = 50;

				try {
					const res = await fetch("/api/score", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							competitor_id: viewerId,
							climb_number: climb,
							attempts,
							topped,
						}),
					});

					if (!res.ok) {
						const t = await res.text();
						showStatus(status, "Error: " + t, false);
						return;
					}

					const data = await res.json();
					showStatus(status, "Saved");

					const pointsSpan = card.querySelector(".points-scored-value");
					if (pointsSpan && data && typeof data.points === "number") {
						pointsSpan.textContent = data.points;
					}

					await refreshTotalPoints();
					refreshPosition();
				} catch (e) {
					showStatus(status, "Network error", false);
				}
			}

			async function refreshTotalPoints() {
				if (viewerId === null) return;
				try {
					const res = await fetch(`/api/score/${viewerId}`);
					const rows = await res.json();
					const totalEl = document.getElementById("total-points");
					if (!totalEl) return;

					let totalPoints = 0;
					rows.forEach((r) => { totalPoints += r.points || 0; });
					totalEl.textContent = totalPoints;
				} catch (e) {}
			}

			async function refreshPosition() {
				if (viewerId === null) return;
				try {
					const res = await fetch("/api/leaderboard");
					const data = await res.json();
					if (!data.rows) return;

					const posValue = document.getElementById("position-value");
					if (!posValue) return;

					for (const row of data.rows) {
						if (row.competitor_id === viewerId) {
							posValue.textContent = row.position;
							break;
						}
					}
				} catch (e) {}
			}

			if (canEdit) {
				cards.forEach((card) => {
					const flashBtn = card.querySelector(".flash-btn");
					const toppedToggle = card.querySelector(".topped-toggle-btn");
					const attemptsContainer = card.querySelector(".attempts-pill-row");
					const attemptButtons = attemptsContainer ? Array.from(attemptsContainer.querySelectorAll(".attempt-pill")) : [];

					if (flashBtn) {
						flashBtn.addEventListener("click", async () => {
							if (!attemptsContainer) return;

							attemptsContainer.dataset.selectedAttempt = "1";
							attemptButtons.forEach((btn) => {
								btn.classList.toggle("is-active", btn.dataset.attempt === "1");
							});

							flashBtn.classList.add("is-active");
							if (toppedToggle) toppedToggle.classList.remove("is-active");

							await save(card, { attempts: 1, topped: true });
						});
					}

					if (toppedToggle) {
						toppedToggle.addEventListener("click", async () => {
							const nowActive = !toppedToggle.classList.contains("is-active");
							toppedToggle.classList.toggle("is-active", nowActive);
							if (flashBtn && nowActive) flashBtn.classList.remove("is-active");
							await save(card);
						});
					}

					attemptButtons.forEach((btn) => {
						btn.addEventListener("click", async () => {
							const attempt = btn.dataset.attempt;
							attemptsContainer.dataset.selectedAttempt = attempt;
							attemptButtons.forEach((b) => { b.classList.toggle("is-active", b === btn); });
							await save(card);
						});
					});
				});
			}

			document.addEventListener("click", function (event) {
				const dot = event.target.closest(".map-dot-interactive");
				if (!dot) return;

				const climb = dot.dataset.climb;
				const row = document.querySelector('.climb-row[data-climb-row="' + climb + '"]');
				if (!row) return;

				row.scrollIntoView({ behavior: "smooth", block: "center" });
				row.classList.add("climb-row-highlight");
				setTimeout(() => { row.classList.remove("climb-row-highlight"); }, 1500);
			});

			refreshTotalPoints();
			refreshPosition();
		</script>
	</body>
</html>
