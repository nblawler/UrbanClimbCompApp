<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Competitor {{ competitor.id }} Â· Urban Climb Comp</title>
		<link rel="stylesheet" href="/static/app.css" />
	</head>
	<body>
		{# Unified nav: uses session competitor as "you", nav_active for highlight #}
		{% set viewer_id = viewer_id if viewer_id is defined else session.get('competitor_id') %}
		<nav class="container top-nav">
			<div class="nav-links">
				<a
					class="back {% if nav_active == 'leaderboard' %}active{% endif %}"
					href="/leaderboard{% if viewer_id %}?cid={{ viewer_id }}{% endif %}"
				>
					Leaderboard
				</a>
				{% if viewer_id %}
					<a
						class="back {% if nav_active == 'sections' %}active{% endif %}"
						href="/competitor/{{ viewer_id }}/sections"
					>
						Enter Scores
					</a>
					<a
						class="back {% if nav_active == 'stats' %}active{% endif %}"
						href="/competitor/{{ viewer_id }}/stats"
					>
						Stats
					</a>
				{% endif %}
			</div>
		</nav>

		<main class="container">

			<!-- Unified header -->
			<header class="comp-header">
				<h1 class="comp-name">
					<span class="comp-label">Name:</span>
					<span class="comp-value">{{ competitor.name }}</span>
				</h1>

				<div class="comp-meta-row">
					<div class="comp-pill">
						<span class="comp-pill-label">Competitor</span>
						<span class="comp-pill-value">{{ competitor.id }}</span>
					</div>

					<div class="comp-pill">
						<span class="comp-pill-label">Points</span>
						<span class="comp-pill-value" id="total-points">{{ total_points }}</span>
					</div>

					{% if position is defined and position is not none %}
						<div class="comp-pill">
							<span class="comp-pill-label">Position</span>
							<span class="comp-pill-value" id="position-value">{{ position }}</span>
						</div>
					{% endif %}
				</div>
			</header>

			<section class="card" style="margin-bottom:16px;">
				<header class="section-header">
					<h2 class="section-title">
						{% if section %} {{ section.name }} {% else %} Climbs {% endif %}
					</h2>
				</header>
			
				<section class="grid">
					{% for n in climbs %}
						{% set s = existing.get(n) %}
						{% set max_pts = max_points.get(n) if max_points is defined else None %}
						{% set col_raw = colours.get(n) if colours is defined else None %}

						{# --- Background selection (special red, white handling) --- #}
						{% if col_raw %}
							{% set lc = col_raw|lower %}
							{% if lc == "red" %}
								{% set col_bg = "#b32121" %}
							{% elif lc in ["white", "#fff", "#ffffff"] %}
								{% set col_bg = "#ffffff" %}
							{% else %}
								{% set col_bg = col_raw %}
							{% endif %}
						{% else %}
							{% set col_bg = None %}
						{% endif %}

						{# --- TEXT COLOUR: black if white background, else white --- #}
						{% if col_bg and col_bg|lower in ["white", "#fff", "#ffffff"] %}
							{% set text_color = "black" %}
						{% else %}
							{% set text_color = "white" %}
						{% endif %}
						
						<div
							class="climb-card"
							data-climb="{{ n }}"
							style="
								background-color: {{ col_bg if col_bg else '#1a1a1a' }};
								color: var(--climb-text);
								--climb-text: {{ text_color }};
							"
						>
							<h3 style="color: var(--climb-text);">Climb #{{ n }}</h3>

							{% if col_raw %}
								<p class="climb-colour" style="color: var(--climb-text);">
									{{ col_raw }}
								</p>
							{% endif %}

							{% if max_pts is not none %}
								<p style="margin:4px 0 0; color: var(--climb-text);">
									Max points: {{ max_pts }}
								</p>
							{% endif %}

							<div class="row">
								<label style="color: var(--climb-text);">Attempts</label>
								<input
									type="number"
									min="1"
									max="50"
									value="{{ s.attempts if s else 1 }}"
									class="attempts"
									style="color: var(--climb-text); background:#ffffff30; border-color:#00000040;"
									{% if not can_edit %}disabled{% endif %}
								/>
							</div>

							<div class="row">
								<label class="check" style="color: var(--climb-text);">
									<input
										type="checkbox"
										class="topped"
										{% if s and s.topped %}checked{% endif %}
										{% if not can_edit %}disabled{% endif %}
									/>
									<span style="color: var(--climb-text);">Topped</span>
								</label>
							</div>

							<button
								class="save"
								style="color: var(--climb-text); border-color: var(--climb-text);"
								{% if not can_edit %}disabled{% endif %}
							>
								Save
							</button>

							<div class="status" aria-live="polite" style="color: var(--climb-text);"></div>
						</div>
					{% endfor %}
				</section>
			</section>

		</main>

		<script>
			// Viewer id comes from the session; that's who we log as.
			const viewerId = {{ viewer_id if viewer_id is not none else 'null' }};
			const competitorIdForDisplay = {{ competitor.id }};
			const canEdit = {{ 'true' if can_edit else 'false' }};

			const cards = document.querySelectorAll(".climb-card");

			function showStatus(el, msg, ok = true) {
				el.textContent = msg;
				el.className = "status " + (ok ? "ok" : "err");
				setTimeout(() => {
					el.textContent = "";
					el.className = "status";
				}, 1500);
			}

			async function save(card) {
				if (!canEdit || viewerId === null) {
					showStatus(card.querySelector(".status"), "Not allowed", false);
					return;
				}

				const climb = parseInt(card.dataset.climb);
				let attempts = parseInt(card.querySelector(".attempts").value || "1");
				const topped = card.querySelector(".topped").checked;
				const status = card.querySelector(".status");

				if (isNaN(attempts) || attempts < 1) {
					attempts = 1;
					card.querySelector(".attempts").value = 1;
				}
				if (attempts > 50) {
					attempts = 50;
					card.querySelector(".attempts").value = 50;
				}

				try {
					const res = await fetch("/api/score", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							// IMPORTANT: always log as viewerId, not whoever is in the URL
							competitor_id: viewerId,
							climb_number: climb,
							attempts,
							topped,
						}),
					});

					if (!res.ok) {
						const t = await res.text();
						showStatus(status, "Error: " + t, false);
						return;
					}

					await res.json();
					showStatus(status, "Saved");

					await refreshTotalPoints();
					refreshPosition();
				} catch (e) {
					showStatus(status, "Network error", false);
				}
			}

			async function refreshTotalPoints() {
				if (viewerId === null) return;
				try {
					const res = await fetch(`/api/score/${viewerId}`);
					const rows = await res.json();
					const totalEl = document.getElementById("total-points");
					if (!totalEl) return;

					let totalPoints = 0;
					rows.forEach((r) => {
						totalPoints += r.points || 0;
					});

					totalEl.textContent = totalPoints;
				} catch (e) {}
			}

			async function refreshPosition() {
				if (viewerId === null) return;
				try {
					const res = await fetch("/api/leaderboard");
					const data = await res.json();

					if (!data.rows) return;

					const posValue = document.getElementById("position-value");
					if (!posValue) return;

					for (const row of data.rows) {
						if (row.competitor_id === viewerId) {
							posValue.textContent = row.position;
							break;
						}
					}
				} catch (e) {}
			}

			if (canEdit) {
				cards.forEach((card) => {
					card.querySelector(".save").addEventListener("click", async () => {
						await save(card);
					});
				});
			}

			// Initial load
			refreshTotalPoints();
			refreshPosition();
		</script>
	</body>
</html>