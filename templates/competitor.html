<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Competitor {{ competitor.id }} · Urban Climb Comp</title>
	<link rel="stylesheet" href="/static/app.css" />

	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background: linear-gradient(135deg, #0a1628 0%, #1a2942 100%);
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			color: #fff;
		}

		/* Top nav */
		.nav {
			padding: 1.25rem 2rem;
			display: flex;
			gap: 1.5rem;
			align-items: center;
			flex-wrap: wrap;
		}

		.nav a {
			color: rgba(255, 255, 255, 0.7);
			text-decoration: none;
			font-size: 0.95rem;
			transition: color 0.2s;
			font-weight: 600;
		}

		.nav a.active {
			color: #5df4a2;
			font-weight: 700;
		}

		.nav a:hover { color: #fff; }

		/* Container */
		.container {
			flex: 1;
			max-width: 1200px;
			margin: 0 auto;
			padding: 2rem;
			width: 100%;
		}

		/* Competitor header */
		.comp-header {
			background: rgba(255, 255, 255, 0.05);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 1.5rem;
			padding: 2rem;
			margin-bottom: 2rem;
		}

		.comp-name {
			font-size: 2rem;
			font-weight: 900;
			margin-bottom: 1.25rem;
			background: linear-gradient(135deg, #fff 0%, #5df4a2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			letter-spacing: -0.02em;
		}

		.comp-meta-row {
			display: flex;
			gap: 1rem;
			flex-wrap: wrap;
		}

		.comp-pill {
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid rgba(255, 255, 255, 0.15);
			border-radius: 0.85rem;
			padding: 0.75rem 1.25rem;
			display: flex;
			flex-direction: column;
			gap: 0.25rem;
			min-width: 110px;
		}

		.comp-pill-label {
			font-size: 0.75rem;
			color: rgba(255, 255, 255, 0.6);
			text-transform: uppercase;
			letter-spacing: 0.05em;
			font-weight: 700;
		}

		.comp-pill-value {
			font-size: 1.5rem;
			font-weight: 900;
			color: #fff;
		}

		/* Section nav row */
		.section-filter-row {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			gap: 1.5rem;
			margin-bottom: 2rem;
			flex-wrap: wrap;
		}

		.section-filter-left {
			display: flex;
			flex-direction: column;
			gap: 0.55rem;
			min-width: 0;
			flex: 1;
		}

		.section-filter-label {
			font-size: 0.95rem;
			color: rgba(255, 255, 255, 0.85);
			font-weight: 800;
		}

		.section-filter-help {
			font-size: 0.85rem;
			color: rgba(255, 255, 255, 0.7);
			font-weight: 650;
		}

		/* Compact section tabs (NAV, not FILTER) */
		.section-tabs {
			display: flex;
			flex-wrap: wrap;
			gap: 0.6rem;
			margin-top: 0.25rem;
		}

		.section-tab {
			display: inline-flex;
			align-items: center;
			gap: 0.6rem;
			padding: 0.55rem 0.85rem;
			border-radius: 999px;
			border: 1px solid rgba(255, 255, 255, 0.16);
			background: rgba(255, 255, 255, 0.05);
			color: rgba(255, 255, 255, 0.92);
			text-decoration: none;
			font-weight: 850;
			max-width: 100%;
			transition: transform 0.15s, background 0.15s, border-color 0.15s;
		}

		.section-tab:hover {
			transform: translateY(-1px);
			background: rgba(255, 255, 255, 0.08);
			border-color: rgba(255, 255, 255, 0.26);
		}

		.section-tab.is-active {
			background: rgba(93, 244, 162, 0.16);
			border-color: rgba(93, 244, 162, 0.55);
			color: #ffffff;
		}

		.section-tab-name {
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			max-width: 20ch;
			line-height: 1.1;
		}

		.section-tab-badge {
			font-size: 0.8rem;
			font-weight: 900;
			padding: 0.2rem 0.55rem;
			border-radius: 999px;
			border: 1px solid rgba(255, 255, 255, 0.18);
			background: rgba(0, 0, 0, 0.25);
			color: rgba(255, 255, 255, 0.9);
			white-space: nowrap;
		}

		.section-tab.is-active .section-tab-badge {
			border-color: rgba(93, 244, 162, 0.6);
		}

		/* Back to map button */
		.back-to-map-btn {
			padding: 0.65rem 1.25rem;
			background: rgba(255, 255, 255, 0.08);
			border: 1px solid rgba(255, 255, 255, 0.15);
			border-radius: 999px;
			color: #fff;
			text-decoration: none;
			font-size: 0.9rem;
			font-weight: 650;
			transition: all 0.2s;
			white-space: nowrap;
			align-self: flex-start;
		}

		.back-to-map-btn:hover {
			background: rgba(255, 255, 255, 0.12);
			transform: translateY(-1px);
		}

		/* Map card */
		.map-card {
			background: rgba(255, 255, 255, 0.05);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 1.5rem;
			padding: 2rem;
			margin-bottom: 2rem;
		}

		.section-header {
			margin-bottom: 1.5rem;
		}

		.section-title {
			font-size: 1.75rem;
			font-weight: 900;
			color: #fff;
		}

		/* Map wrapper */
		.map-wrapper {
			position: relative;
			width: 100%;
			border-radius: 1rem;
			overflow: hidden;
			border: 1px solid rgba(255, 255, 255, 0.1);
			background: #000;
			margin-bottom: 2rem;
		}

		.gym-map {
			display: block;
			width: 100%;
			height: auto;
			max-width: 100%;
		}

		.map-dot {
			position: absolute;
			transform: translate(-50%, -50%);
			min-width: 28px;
			min-height: 28px;
			padding: 0 6px;
			border-radius: 999px;
			background: #5df4a2;
			box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.6);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 0.75rem;
			font-weight: 800;
			border: none;
			cursor: pointer;
			transition: transform 0.2s, box-shadow 0.2s;
		}

		.map-dot:hover {
			transform: translate(-50%, -50%) scale(1.3);
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
			z-index: 10;
		}

		/* Done state for map dots (topped/flashed only) */
		.map-dot.is-done {
			background: #22c55e;
			color: #05060a;
			box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.75);
		}

		/* Climbs section */
		.climbs-section {
			background: rgba(255, 255, 255, 0.05);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 1.5rem;
			padding: 2rem;
		}

		/* Climbs grid */
		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
			gap: 1.25rem;
		}

		/* Climb card (white cards) */
		.climb-card {
			background: #ffffff;
			color: #05060a;
			border-radius: 1rem;
			border: 1px solid rgba(0, 0, 0, 0.08);
			padding: 1.25rem;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
			transition: all 0.2s;
		}

		.climb-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
		}

		/* Highlight when scrolled to */
		.climb-row-highlight {
			outline: 3px solid #5df4a2;
			box-shadow: 0 0 0 1px rgba(93, 244, 162, 0.5);
			background: rgba(93, 244, 162, 0.08);
		}

		/* Climb header */
		.climb-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 0.75rem;
			margin-bottom: 1rem;
		}

		.climb-title {
			font-size: 1.1rem;
			font-weight: 900;
			color: #05060a;
		}

		.climb-colour-pill {
			padding: 0.35rem 0.85rem;
			border-radius: 999px;
			font-size: 0.8rem;
			font-weight: 800;
			border: 1px solid rgba(0, 0, 0, 0.15);
			white-space: nowrap;
		}

		/* Climb info text */
		.climb-card p {
			margin: 0.5rem 0;
			font-size: 0.9rem;
			color: #05060a;
		}

		.points-scored-value {
			font-weight: 900;
			color: #5df4a2;
		}

		/* Climb actions */
		.climb-actions {
			margin-top: 1rem;
			display: flex;
			flex-direction: column;
			gap: 0.75rem;
		}

		.climb-actions-row {
			display: flex;
			align-items: center;
			gap: 0.65rem;
			flex-wrap: wrap;
		}

		.attempts-row { margin-top: 0.25rem; }

		.attempts-label {
			font-size: 0.75rem;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			color: #05060a;
			font-weight: 800;
		}

		.attempts-pill-row {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
		}

		/* Action pills (neutral by default) */
		.action-pill,
		.attempt-pill,
		.topped-toggle-btn,
		.flash-btn {
			border-radius: 999px;
			border: 1px solid rgba(5, 6, 10, 0.2);
			background: #ffffff;
			color: #05060a;
			font-size: 0.85rem;
			padding: 0.5rem 1rem;
			cursor: pointer;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			transition: all 0.2s;
		}

		.action-pill:hover,
		.attempt-pill:hover,
		.topped-toggle-btn:hover,
		.flash-btn:hover {
			background: #f3f4f6;
			border-color: rgba(5, 6, 10, 0.3);
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
		}

		.action-pill:disabled,
		.attempt-pill:disabled,
		.topped-toggle-btn:disabled,
		.flash-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		/* Active state styles */
		.flash-btn.is-active {
			background: #0ea5e9;
			border-color: #0ea5e9;
			color: #ffffff;
			box-shadow: 0 10px 26px rgba(14, 165, 233, 0.35);
		}

		.topped-toggle-btn.is-active {
			background: #111827;
			border-color: #111827;
			color: #ffffff;
			box-shadow: 0 10px 26px rgba(17, 24, 39, 0.28);
		}

		.attempt-pill.is-active {
			background: #16a34a;
			border-color: #16a34a;
			color: #ffffff;
			box-shadow: 0 10px 26px rgba(22, 163, 74, 0.28);
		}

		/* Status message */
		.status {
			min-height: 1.2em;
			font-size: 0.85rem;
			color: rgba(5, 6, 10, 0.6);
			margin-top: 0.5rem;
		}

		.status.ok {
			color: #16a34a;
			font-weight: 800;
		}

		.status.err {
			color: #dc2626;
			font-weight: 800;
		}

		/* Alert */
		.alert {
			padding: 1rem;
			border-radius: 0.75rem;
			background: rgba(251, 113, 133, 0.12);
			border: 1px solid rgba(251, 113, 133, 0.3);
			color: rgba(255, 255, 255, 0.9);
		}

		/* Responsive */
		@media (max-width: 768px) {
			.nav { padding: 1rem; }
			.container { padding: 1.5rem 1rem; }
			.comp-header { padding: 1.5rem; }
			.comp-name { font-size: 1.6rem; }
			.section-filter-row { flex-direction: column; align-items: flex-start; }
			.map-card, .climbs-section { padding: 1.5rem; }
			.section-title { font-size: 1.4rem; }
			.grid { grid-template-columns: 1fr; }
			.section-tab-name { max-width: 26ch; }
		}

		@media (max-width: 520px) {
			.comp-meta-row { gap: 0.75rem; }
			.comp-pill { flex: 1 1 calc(50% - 0.375rem); min-width: 0; }
			.section-tab { width: 100%; justify-content: space-between; }
			.section-tab-name { max-width: 100%; }
		}
	</style>
</head>

<body>
	{% set is_logged_in = session.get('account_id') %}
	{% set viewer_id = session.get('competitor_id') %}
	{% set is_admin = session.get('admin_ok', False) %}
	{% set comp_slug = comp_slug if comp_slug is defined else session.get('active_comp_slug') %}
	{% set show_comp_nav = (is_logged_in and viewer_id and comp_slug) %}

	<nav class="nav">
		<a href="{% if is_logged_in or is_admin %}/my-comps{% else %}/{% endif %}"
		   class="{% if nav_active == 'my_comps' %}active{% endif %}">
			Home
		</a>

		{% if is_admin %}
			<a href="/admin/comps" class="{% if nav_active == 'admin' %}active{% endif %}">Admin</a>
		{% endif %}

		{% if show_comp_nav %}
			<a href="/comp/{{ comp_slug }}/competitor/{{ viewer_id }}/sections"
			   class="{% if nav_active == 'sections' %}active{% endif %}">
				Scoring
			</a>

			<a href="/competitor/{{ viewer_id }}/stats/my"
			   class="{% if nav_active == 'my_stats' %}active{% endif %}">
				My Stats
			</a>

			<a href="/competitor/{{ viewer_id }}/stats/overall"
			   class="{% if nav_active == 'overall_stats' %}active{% endif %}">
				Overall Stats
			</a>
		{% endif %}

		<a href="/leaderboard{% if show_comp_nav %}?cid={{ viewer_id }}{% endif %}"
		   class="{% if nav_active == 'leaderboard' %}active{% endif %}">
			Leaderboard
		</a>

		{% if is_logged_in or is_admin %}
			<a href="/logout">Log out</a>
		{% else %}
			<a href="/login{% if comp_slug %}?slug={{ comp_slug }}{% endif %}"
			   class="{% if nav_active == 'login' %}active{% endif %}">
				Log in
			</a>
		{% endif %}
	</nav>

	<main class="container">
		<header class="comp-header">
			<h1 class="comp-name">{{ competitor.name }}</h1>

			<div class="comp-meta-row">
				<div class="comp-pill">
					<span class="comp-pill-label">Competitor</span>
					<span class="comp-pill-value">{{ competitor.id }}</span>
				</div>

				<div class="comp-pill">
					<span class="comp-pill-label">Points</span>
					<span class="comp-pill-value" id="total-points">{{ total_points }}</span>
				</div>

				{% if position is defined and position is not none %}
					<div class="comp-pill">
						<span class="comp-pill-label">Position</span>
						<span class="comp-pill-value" id="position-value">{{ position }}</span>
					</div>
				{% endif %}
			</div>
		</header>

		{% if sections is defined and sections %}
		<div class="section-filter-row">
			<div class="section-filter-left">
				<div class="section-filter-label">Jump to a section:</div>

				<div class="section-tabs" id="sectionTabs">
					{% for sec in sections %}
						<a
							href="/competitor/{{ competitor.id }}/section/{{ sec.slug }}"
							class="section-tab {% if section is defined and section and section.id == sec.id %}is-active{% endif %}"
							data-section-id="{{ sec.id }}"
							aria-label="Go to section {{ sec.name }}"
						>
							<span class="section-tab-name">{{ sec.name }}</span>
							<span class="section-tab-badge">
								<span class="sec-done">—</span>/<span class="sec-total">—</span>
							</span>
						</a>
					{% endfor %}
				</div>
			</div>

			{% if comp_slug %}
				<a class="back-to-map-btn" href="/comp/{{ comp_slug }}/competitor/{{ competitor.id }}/sections">Back to Gym Map</a>
			{% else %}
				<a class="back-to-map-btn" href="/competitor/{{ competitor.id }}/sections">Back to Gym Map</a>
			{% endif %}
		</div>
		{% endif %}

		{% if section_climbs is defined %}
		<section class="map-card">
			<header class="section-header">
				<h2 class="section-title">{{ section.name }}</h2>
			</header>

			<div class="map-wrapper">
				{% if gym_map_url %}
					<img class="gym-map" src="{{ gym_map_url }}" alt="Gym map" />
				{% else %}
				<div class="alert">
					No gym map found for this competition/gym.
				</div>
				{% endif %}

				{% for sc in section_climbs %}
					{% if sc.x_percent is not none and sc.y_percent is not none %}
						{% set col_raw = sc.colour %}
						{% if col_raw %}
							{% set lc = col_raw|lower %}
							{% if lc == "red" %}
								{% set bg = "#b32121" %}
							{% elif lc in ["white", "#fff", "#ffffff"] %}
								{% set bg = "#ffffff" %}
							{% else %}
								{% set bg = col_raw %}
							{% endif %}
						{% else %}
							{% set bg = "#5df29c" %}
						{% endif %}

						{% set text_color = "#000000" %}

						<button
							type="button"
							class="map-dot map-dot-interactive"
							style="left: {{ sc.x_percent }}%; top: {{ sc.y_percent }}%; background: {{ bg }}; color: {{ text_color }};"
							data-climb="{{ sc.climb_number }}"
							data-section-climb-id="{{ sc.id }}"
							title="Climb {{ sc.climb_number }}{% if sc.colour %} · {{ sc.colour }}{% endif %}"
						>
							{{ sc.climb_number }}
						</button>
					{% endif %}
				{% endfor %}
			</div>
		</section>
		{% endif %}

		<section class="climbs-section">
			<header class="section-header">
				<h2 class="section-title">
					{% if section %} {{ section.name }} {% else %} Climbs {% endif %}
				</h2>
			</header>

			<div class="grid">
				{% if section_climbs is defined %}
					{% for sc in section_climbs %}
						{% set n = sc.climb_number %}
						{% set s = existing.get(sc.id) %}
						{% set max_pts = sc.base_points if sc.base_points is not none else (max_points.get(n) if max_points is defined else None) %}
						{% set col_raw = sc.colour if sc.colour else (colours.get(n) if colours is defined else None) %}

						{% if col_raw %}
							{% set lc = col_raw|lower %}
							{% if lc == "red" %}
								{% set col_bg = "#b32121" %}
							{% elif lc in ["white", "#fff", "#ffffff"] %}
								{% set col_bg = "#ffffff" %}
							{% else %}
								{% set col_bg = col_raw %}
							{% endif %}
						{% else %}
							{% set col_bg = "#e5e7eb" %}
						{% endif %}

						{% if col_bg|lower in ["white", "#fff", "#ffffff", "#e5e7eb", "#facc15", "#fef9c3"] %}
							{% set pill_text_color = "#05060a" %}
						{% else %}
							{% set pill_text_color = "#ffffff" %}
						{% endif %}

						{% set cap = sc.attempt_cap if sc.attempt_cap else 5 %}

						{% if s %}
							{% set sel_attempt = s.attempts if s.attempts else 1 %}
						{% else %}
							{% set sel_attempt = 1 %}
						{% endif %}
						{% if sel_attempt > cap %}
							{% set sel_attempt = cap %}
						{% endif %}

						{% set is_topped = (s and s.topped) %}
						{% set is_flashed = (s and s.flashed) %}

						<div
							class="climb-card climb-row"
							id="climb-{{ n }}"
							data-climb="{{ n }}"
							data-climb-row="{{ n }}"
							data-section-climb-id="{{ sc.id }}"
							data-attempt-cap="{{ cap }}"
							data-initial-attempt="{{ sel_attempt }}"
							data-initial-topped="{{ '1' if is_topped else '0' }}"
							data-initial-flashed="{{ '1' if is_flashed else '0' }}"
						>
							<div class="climb-header">
								<span class="climb-title">Climb #{{ n }}</span>

								{% if col_raw %}
									<span class="climb-colour-pill" style="background: {{ col_bg }}; color: {{ pill_text_color }};">
										{{ col_raw }}
									</span>
								{% endif %}
							</div>

							{% if max_pts is not none %}
								<p>Max Points: <strong>{{ max_pts }}</strong></p>
							{% endif %}

							<p>
								Points Scored:
								<span class="points-scored-value">
									{% if per_climb_points is defined %}
										{{ per_climb_points.get(n, 0) }}
									{% else %}
										0
									{% endif %}
								</span>
							</p>

							<div class="climb-actions">
								<div class="climb-actions-row">
									<button
										type="button"
										class="flash-btn action-pill {% if is_flashed %}is-active{% endif %}"
										{% if not can_edit %}disabled{% endif %}
									>
										Flash
									</button>

									<button
										type="button"
										class="topped-toggle-btn action-pill {% if is_topped and not is_flashed %}is-active{% endif %}"
										{% if not can_edit %}disabled{% endif %}
									>
										Topped
									</button>
								</div>

								<div class="climb-actions-row attempts-row">
									<span class="attempts-label">Attempts</span>
									<div class="attempts-pill-row" data-selected-attempt="{{ sel_attempt }}">
										{% for i in range(1, cap + 1) %}
											<button
												type="button"
												class="attempt-pill {% if i == sel_attempt %}is-active{% endif %}"
												data-attempt="{{ i }}"
												{% if not can_edit %}disabled{% endif %}
											>
												{{ i }}
											</button>
										{% endfor %}
									</div>
								</div>

								<div class="status" aria-live="polite"></div>
							</div>
						</div>
					{% endfor %}
				{% else %}
					<div class="alert">No climbs found for this section.</div>
				{% endif %}
			</div>
		</section>
	</main>

	<script>
		const viewerId = {{ viewer_id if viewer_id is not none else 'null' }};
		const competitorIdForDisplay = {{ competitor.id }};
		const canEdit = {{ 'true' if can_edit else 'false' }};

		const cards = document.querySelectorAll(".climb-card");

		function showStatus(el, msg, ok = true) {
			if (!el) return;
			el.textContent = msg;
			el.className = "status " + (ok ? "ok" : "err");
			setTimeout(() => {
				el.textContent = "";
				el.className = "status";
			}, 1500);
		}

		function getCurrentState(card) {
			const attemptsContainer = card.querySelector(".attempts-pill-row");
			const toppedToggle = card.querySelector(".topped-toggle-btn");
			const flashBtn = card.querySelector(".flash-btn");

			let attempts = 1;
			if (attemptsContainer) {
				const raw = attemptsContainer.dataset.selectedAttempt || "1";
				const parsed = parseInt(raw, 10);
				if (!isNaN(parsed) && parsed >= 1) attempts = parsed;
			}

			const topped = !!(toppedToggle && toppedToggle.classList.contains("is-active"));
			const flashed = !!(flashBtn && flashBtn.classList.contains("is-active"));
			return { attempts, topped, flashed };
		}

		// Ensure toggles reflect server state on load
		function hydrateFromDataset(card) {
			const attemptsContainer = card.querySelector(".attempts-pill-row");
			const attemptButtons = attemptsContainer ? Array.from(attemptsContainer.querySelectorAll(".attempt-pill")) : [];

			const initialAttempt = parseInt(card.dataset.initialAttempt || "1", 10);
			const initialTopped = card.dataset.initialTopped === "1";
			const initialFlashed = card.dataset.initialFlashed === "1";

			if (attemptsContainer) {
				const attempt = (!isNaN(initialAttempt) && initialAttempt >= 1) ? String(initialAttempt) : "1";
				attemptsContainer.dataset.selectedAttempt = attempt;
				attemptButtons.forEach((btn) => btn.classList.toggle("is-active", btn.dataset.attempt === attempt));
			}

			const flashBtn = card.querySelector(".flash-btn");
			const toppedBtn = card.querySelector(".topped-toggle-btn");

			if (flashBtn) flashBtn.classList.toggle("is-active", initialFlashed);
			if (toppedBtn) toppedBtn.classList.toggle("is-active", initialTopped && !initialFlashed);
		}

		cards.forEach(hydrateFromDataset);

		async function save(card, override) {
			if (!canEdit || viewerId === null) {
				showStatus(card.querySelector(".status"), "Not allowed", false);
				return;
			}

			const climb = parseInt(card.dataset.climb, 10);
			const sectionClimbId = parseInt(card.dataset.sectionClimbId, 10);
			const status = card.querySelector(".status");

			let { attempts, topped, flashed } = getCurrentState(card);

			if (override && typeof override.attempts === "number") attempts = override.attempts;
			if (override && typeof override.topped === "boolean") topped = override.topped;
			if (override && typeof override.flashed === "boolean") flashed = override.flashed;

			if (isNaN(attempts) || attempts < 1) attempts = 1;
			if (attempts > 50) attempts = 50;

			try {
				const res = await fetch("/api/score", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({
						competitor_id: viewerId,
						section_climb_id: isNaN(sectionClimbId) ? null : sectionClimbId,
						climb_number: climb, // keep for backwards compatibility
						attempts,
						topped,
						flashed,
					}),
				});

				if (!res.ok) {
					const t = await res.text();
					showStatus(status, "Error: " + t, false);
					return;
				}

				const data = await res.json();
				showStatus(status, "Saved");

				const pointsSpan = card.querySelector(".points-scored-value");
				if (pointsSpan && data && typeof data.points === "number") {
					pointsSpan.textContent = data.points;
				}

				await refreshTotalPoints();
				refreshPosition();
				await refreshDoneDotsAndActiveTab();
			} catch (e) {
				showStatus(status, "Network error", false);
			}
		}

		async function refreshTotalPoints() {
			if (viewerId === null) return;
			try {
				const res = await fetch(`/api/score/${viewerId}`);
				const rows = await res.json();
				const totalEl = document.getElementById("total-points");
				if (!totalEl) return;

				let totalPoints = 0;
				(rows || []).forEach((r) => { totalPoints += r.points || 0; });
				totalEl.textContent = totalPoints;
			} catch (e) {}
		}

		async function refreshPosition() {
			if (viewerId === null) return;
			try {
				const res = await fetch("/api/leaderboard");
				const data = await res.json();
				if (!data.rows) return;

				const posValue = document.getElementById("position-value");
				if (!posValue) return;

				for (const row of data.rows) {
					if (row.competitor_id === viewerId) {
						posValue.textContent = row.position;
						break;
					}
				}
			} catch (e) {}
		}

		if (canEdit) {
			cards.forEach((card) => {
				const flashBtn = card.querySelector(".flash-btn");
				const toppedToggle = card.querySelector(".topped-toggle-btn");
				const attemptsContainer = card.querySelector(".attempts-pill-row");
				const attemptButtons = attemptsContainer ? Array.from(attemptsContainer.querySelectorAll(".attempt-pill")) : [];

				if (flashBtn) {
					flashBtn.addEventListener("click", async () => {
						if (!attemptsContainer) return;

						// Flash implies: attempts=1, topped=true, flashed=true
						attemptsContainer.dataset.selectedAttempt = "1";
						attemptButtons.forEach((btn) => {
							btn.classList.toggle("is-active", btn.dataset.attempt === "1");
						});

						flashBtn.classList.add("is-active");
						if (toppedToggle) toppedToggle.classList.remove("is-active");

						await save(card, { attempts: 1, topped: true, flashed: true });
					});
				}

				if (toppedToggle) {
					toppedToggle.addEventListener("click", async () => {
						const nowActive = !toppedToggle.classList.contains("is-active");
						toppedToggle.classList.toggle("is-active", nowActive);

						// If you manually topped it, it is NOT flashed.
						if (flashBtn && nowActive) flashBtn.classList.remove("is-active");

						await save(card, { topped: nowActive, flashed: false });
					});
				}

				attemptButtons.forEach((btn) => {
					btn.addEventListener("click", async () => {
						const attempt = btn.dataset.attempt;
						attemptsContainer.dataset.selectedAttempt = attempt;
						attemptButtons.forEach((b) => { b.classList.toggle("is-active", b === btn); });

						// Changing attempts makes it not a flash anymore
						if (flashBtn) flashBtn.classList.remove("is-active");

						await save(card, { flashed: false });
					});
				});
			});
		}

		document.addEventListener("click", function (event) {
			const dot = event.target.closest(".map-dot-interactive");
			if (!dot) return;

			const climb = dot.dataset.climb;
			const row = document.querySelector('.climb-row[data-climb-row="' + climb + '"]');
			if (!row) return;

			row.scrollIntoView({ behavior: "smooth", block: "center" });
			row.classList.add("climb-row-highlight");
			setTimeout(() => { row.classList.remove("climb-row-highlight"); }, 1500);
		});

		// DONE = topped OR flashed.
		// Uses section_climb_id to avoid collisions across sections.
		async function refreshDoneDotsAndActiveTab() {
			const dots = Array.from(document.querySelectorAll(".map-dot-interactive"));
			const activeTab = document.querySelector(".section-tab.is-active");
			if (!dots.length && !activeTab) return;

			const totalInThisSection = dots.length;

			function setActiveTab(done, total) {
				if (!activeTab) return;
				activeTab.querySelectorAll(".sec-done").forEach(el => el.textContent = String(done));
				activeTab.querySelectorAll(".sec-total").forEach(el => el.textContent = String(total));
			}

			try {
				if (viewerId === null) return;

				const res = await fetch(`/api/score/${viewerId}`);
				if (!res.ok) return;
				const rows = await res.json();

				// Expect API to include section_climb_id. If it doesn't, dots will still work
				// by climb_number, but collisions may occur across sections.
				const doneBySectionClimbId = new Set();
				const doneByClimbNumber = new Set();

				(rows || []).forEach((r) => {
					const isDone = !!(r && (r.topped || r.flashed));
					if (!isDone) return;

					if (r.section_climb_id !== undefined && r.section_climb_id !== null) {
						doneBySectionClimbId.add(String(r.section_climb_id));
					}
					if (r.climb_number !== undefined && r.climb_number !== null) {
						doneByClimbNumber.add(String(r.climb_number));
					}
				});

				let doneCountThisSection = 0;
				dots.forEach((d) => {
					const sid = String(d.dataset.sectionClimbId || "");
					const cn = String(d.dataset.climb || "");

					const isDone = (sid && doneBySectionClimbId.has(sid)) || (cn && doneByClimbNumber.has(cn));
					d.classList.toggle("is-done", isDone);
					if (isDone) doneCountThisSection += 1;
				});

				setActiveTab(doneCountThisSection, totalInThisSection);
			} catch (e) {}
		}

		refreshTotalPoints();
		refreshPosition();
		refreshDoneDotsAndActiveTab();
	</script>
</body>
</html>
